<channel version="4.4.0">
  <id>aaf33967-fc20-40f2-ac82-8f717f7e8fd1</id>
  <nextMetaDataId>5</nextMetaDataId>
  <name>Discharge Input</name>
  <description></description>
  <revision>73</revision>
  <sourceConnector version="4.4.0">
    <metaDataId>0</metaDataId>
    <name>sourceConnector</name>
    <properties class="com.mirth.connect.connectors.vm.VmReceiverProperties" version="4.4.0">
      <pluginProperties/>
      <sourceConnectorProperties version="4.4.0">
        <responseVariable>None</responseVariable>
        <respondAfterProcessing>true</respondAfterProcessing>
        <processBatch>false</processBatch>
        <firstResponse>false</firstResponse>
        <processingThreads>1</processingThreads>
        <resourceIds class="linked-hash-map">
          <entry>
            <string>Default Resource</string>
            <string>[Default Resource]</string>
          </entry>
        </resourceIds>
        <queueBufferSize>1000</queueBufferSize>
      </sourceConnectorProperties>
    </properties>
    <transformer version="4.4.0">
      <elements>
        <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="4.4.0">
          <sequenceNumber>0</sequenceNumber>
          <enabled>true</enabled>
          <script>var env = getEnvironmentConfig(&apos;settings&apos;) 
//logger.debug(&quot;ENV: &quot; + JSON.stringify(env.clients))

channelMap.put(&apos;clientName&apos;, env.clients[0].name);
channelMap.put(&apos;clientId&apos;, env.clients[0].id);
channelMap.put(&apos;connectionString&apos;, env.clients[0].connectionString);
var location = msg[&apos;MSH&apos;][&apos;MSH.4&apos;][&apos;MSH.4.1&apos;].toString();
channelMap.put(&apos;sendingLocation&apos;, location);

var mapping;

try {
    mapping = &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1lIjoic3RyaW5nIiwiaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMvbmFtZWlkZW50aWZpZXIiOiJzdHJpbmciLCJ0ZW5hbnRfaWQiOiIxIiwidGVuYW50X2NvZGUiOiJzdHJpbmciLCJqdGkiOiJlZGVkNjczMC0yMTBhLTQwNmYtODJlNC01NTYwNjg1OTA5ZDIiLCJpYXQiOiIxNzYwNTcyMjUzIiwiZXhwIjoxNzYwNjU4NjUzLCJpc3MiOiJodHRwczovL2hlYWx0aGV4dGVudC5jb20iLCJhdWQiOiJodHRwczovL2hlYWx0aGV4dGVudC5jb20ifQ.odAE0aPl1sA0wPRmVUYhMSS3RVr_mVRZ6K0LyQsGf7Q&quot;;
} catch (e) {
    mapping = &apos;&apos;;
}

channelMap.put(&apos;accessToken&apos;, validate(mapping, &apos;&apos;, new Array()));</script>
        </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>
      </elements>
      <inboundTemplate encoding="base64"></inboundTemplate>
      <outboundTemplate encoding="base64"></outboundTemplate>
      <inboundDataType>HL7V2</inboundDataType>
      <outboundDataType>HL7V2</outboundDataType>
      <inboundProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DataTypeProperties" version="4.4.0">
        <serializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2SerializationProperties" version="4.4.0">
          <handleRepetitions>true</handleRepetitions>
          <handleSubcomponents>true</handleSubcomponents>
          <useStrictParser>false</useStrictParser>
          <useStrictValidation>false</useStrictValidation>
          <stripNamespaces>false</stripNamespaces>
          <segmentDelimiter>\r</segmentDelimiter>
          <convertLineBreaks>true</convertLineBreaks>
        </serializationProperties>
        <deserializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DeserializationProperties" version="4.4.0">
          <useStrictParser>false</useStrictParser>
          <useStrictValidation>false</useStrictValidation>
          <segmentDelimiter>\r</segmentDelimiter>
        </deserializationProperties>
        <batchProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2BatchProperties" version="4.4.0">
          <splitType>MSH_Segment</splitType>
          <batchScript></batchScript>
        </batchProperties>
        <responseGenerationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseGenerationProperties" version="4.4.0">
          <segmentDelimiter>\r</segmentDelimiter>
          <successfulACKCode>AA</successfulACKCode>
          <successfulACKMessage></successfulACKMessage>
          <errorACKCode>AE</errorACKCode>
          <errorACKMessage>An Error Occurred Processing Message.</errorACKMessage>
          <rejectedACKCode>AR</rejectedACKCode>
          <rejectedACKMessage>Message Rejected.</rejectedACKMessage>
          <msh15ACKAccept>false</msh15ACKAccept>
          <dateFormat>yyyyMMddHHmmss.SSS</dateFormat>
        </responseGenerationProperties>
        <responseValidationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseValidationProperties" version="4.4.0">
          <successfulACKCode>AA,CA</successfulACKCode>
          <errorACKCode>AE,CE</errorACKCode>
          <rejectedACKCode>AR,CR</rejectedACKCode>
          <validateMessageControlId>true</validateMessageControlId>
          <originalMessageControlId>Destination_Encoded</originalMessageControlId>
          <originalIdMapVariable></originalIdMapVariable>
        </responseValidationProperties>
      </inboundProperties>
      <outboundProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DataTypeProperties" version="4.4.0">
        <serializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2SerializationProperties" version="4.4.0">
          <handleRepetitions>true</handleRepetitions>
          <handleSubcomponents>true</handleSubcomponents>
          <useStrictParser>false</useStrictParser>
          <useStrictValidation>false</useStrictValidation>
          <stripNamespaces>false</stripNamespaces>
          <segmentDelimiter>\r</segmentDelimiter>
          <convertLineBreaks>true</convertLineBreaks>
        </serializationProperties>
        <deserializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DeserializationProperties" version="4.4.0">
          <useStrictParser>false</useStrictParser>
          <useStrictValidation>false</useStrictValidation>
          <segmentDelimiter>\r</segmentDelimiter>
        </deserializationProperties>
        <batchProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2BatchProperties" version="4.4.0">
          <splitType>MSH_Segment</splitType>
          <batchScript></batchScript>
        </batchProperties>
        <responseGenerationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseGenerationProperties" version="4.4.0">
          <segmentDelimiter>\r</segmentDelimiter>
          <successfulACKCode>AA</successfulACKCode>
          <successfulACKMessage></successfulACKMessage>
          <errorACKCode>AE</errorACKCode>
          <errorACKMessage>An Error Occurred Processing Message.</errorACKMessage>
          <rejectedACKCode>AR</rejectedACKCode>
          <rejectedACKMessage>Message Rejected.</rejectedACKMessage>
          <msh15ACKAccept>false</msh15ACKAccept>
          <dateFormat>yyyyMMddHHmmss.SSS</dateFormat>
        </responseGenerationProperties>
        <responseValidationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseValidationProperties" version="4.4.0">
          <successfulACKCode>AA,CA</successfulACKCode>
          <errorACKCode>AE,CE</errorACKCode>
          <rejectedACKCode>AR,CR</rejectedACKCode>
          <validateMessageControlId>true</validateMessageControlId>
          <originalMessageControlId>Destination_Encoded</originalMessageControlId>
          <originalIdMapVariable></originalIdMapVariable>
        </responseValidationProperties>
      </outboundProperties>
    </transformer>
    <filter version="4.4.0">
      <elements/>
    </filter>
    <transportName>Channel Reader</transportName>
    <mode>SOURCE</mode>
    <enabled>true</enabled>
    <waitForPrevious>true</waitForPrevious>
  </sourceConnector>
  <destinationConnectors>
    <connector version="4.4.0">
      <metaDataId>1</metaDataId>
      <name>Patient</name>
      <properties class="com.mirth.connect.connectors.vm.VmDispatcherProperties" version="4.4.0">
        <pluginProperties/>
        <destinationConnectorProperties version="4.4.0">
          <queueEnabled>false</queueEnabled>
          <sendFirst>false</sendFirst>
          <retryIntervalMillis>10000</retryIntervalMillis>
          <regenerateTemplate>false</regenerateTemplate>
          <retryCount>0</retryCount>
          <rotate>false</rotate>
          <includeFilterTransformer>false</includeFilterTransformer>
          <threadCount>1</threadCount>
          <threadAssignmentVariable></threadAssignmentVariable>
          <validateResponse>false</validateResponse>
          <resourceIds class="linked-hash-map">
            <entry>
              <string>Default Resource</string>
              <string>[Default Resource]</string>
            </entry>
          </resourceIds>
          <queueBufferSize>1000</queueBufferSize>
          <reattachAttachments>true</reattachAttachments>
        </destinationConnectorProperties>
        <channelId>none</channelId>
        <channelTemplate>${message.encodedData}</channelTemplate>
        <mapVariables/>
      </properties>
      <transformer version="4.4.0">
        <elements>
          <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="4.4.0">
            <name>Select patient from Patient db</name>
            <sequenceNumber>0</sequenceNumber>
            <enabled>true</enabled>
            <script>var patientFirstname = msg[&apos;PID&apos;][&apos;PID.5&apos;][&apos;PID.5.2&apos;].toString();
var patientLastname = msg[&apos;PID&apos;][&apos;PID.5&apos;][&apos;PID.5.1&apos;].toString();

var query = &quot;SELECT * FROM he.Patient Where TenantKey=&apos;&quot; + $(&apos;clientId&apos;) + &quot;&apos; AND FamilyName =&apos;&quot; + patientLastname + &quot;&apos; AND GivenName =&apos;&quot; + patientFirstname + &quot;&apos;&quot;;
var patients = selectQueryBuilder(query);
channelMap.put(&apos;SelectedPatient&apos;, patients[0])</script>
          </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>
        </elements>
        <inboundTemplate encoding="base64">TVNIfF5+XCZ8RUhSfE5vcnRoIEJyb3dhcmQgSG9zcGl0YWx8UkVTVUxUU3xOb3J0aCBCcm93YXJkIEhvc3BpdGFsfDIwMjUxMDE2MTMwMDAwfHxPUlVeUjAxXk9SVV9SMDF8TkJILU9SVS0yMDI1MTAxNi0wMDAzfFB8Mi41ClBJRHwxfHxOQkgwMDAxMjZeXl5OQkheTVJ8fEJyb3duXkxpYW1eS3x8MjAwMTExMzB8TXx8fDgyMCBTVyAxMHRoIFN0Xl5EZWVyZmllbGQgQmVhY2heRkxeMzM0NDFeVVNBfHwrMSg5NTQpNTU1LTA0NDB8fHx8fDk5OS00NS02Nzg5ClBWMXwxfE98T1BEXkNMSU5eMDdeTkJIXl5ST09NfHx8fHxeXl58fHx8fHx8fHxWMDAwNHx8fHx8fHx8fHx8fHx8fHxBfHx8MjAyNTEwMTUxMDU1NDUKT1JDfFJFfFYwMDA0fHx8Ck9CUnwxfFYwMDA0fHwxODg0Mi01XkRpc2NoYXJnZSBzdW1tYXJ5XkxOfFJ8fDIwMjUxMDE1MTA1NTQ1fDIwMjUxMDE2MTI1NTAwfHx8fHx8fHw0MTIwMF5Hb256YWxlel5FbGVuYV5eXk1EXl5OUEl8fHx8fHxGCk9CWHwxfFRYfDE4ODQyLTVeRGlzY2hhcmdlIHN1bW1hcnleTE58fFNlZW4gaW4gY2xpbmljIGZvciBtaWdyYWluZSBleGFjZXJiYXRpb24uIFN5bXB0b21zIGltcHJvdmVkIHdpdGggdGhlcmFweS4gRGlzY2hhcmdlZCB3aXRoIHByZXZlbnRpdmUgcmVnaW1lbiBhbmQgbmV1cm9sb2d5IGZvbGxvdy11cC58Tnx8fHx8MjAyNTEwMTYxMzAwMDAKT0JYfDJ8VFh8QURNX0RPQ15BZG1pdHRpbmcgZG9jdG9yXkx8fDQxMjAwXkdvbnphbGV6XkVsZW5hXl5eTUReXk5QSXxOCk9CWHwzfFRYfENPTlNfRE9DXkNvbnN1bHRpbmcgZG9jdG9yXkx8fE5vbmUgcmVjb3JkZWR8TgpPQlh8NHxUWHxESVNfRE9DXkRpc2NoYXJnZSBkb2N0b3JeTHx8NDEyMDBeR29uemFsZXpeRWxlbmFeXl5NRF5eTlBJfE4K</inboundTemplate>
        <outboundTemplate encoding="base64"></outboundTemplate>
        <inboundDataType>HL7V2</inboundDataType>
        <outboundDataType>HL7V2</outboundDataType>
        <inboundProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DataTypeProperties" version="4.4.0">
          <serializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2SerializationProperties" version="4.4.0">
            <handleRepetitions>true</handleRepetitions>
            <handleSubcomponents>true</handleSubcomponents>
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <stripNamespaces>false</stripNamespaces>
            <segmentDelimiter>\r</segmentDelimiter>
            <convertLineBreaks>true</convertLineBreaks>
          </serializationProperties>
          <deserializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DeserializationProperties" version="4.4.0">
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <segmentDelimiter>\r</segmentDelimiter>
          </deserializationProperties>
          <batchProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2BatchProperties" version="4.4.0">
            <splitType>MSH_Segment</splitType>
            <batchScript></batchScript>
          </batchProperties>
          <responseGenerationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseGenerationProperties" version="4.4.0">
            <segmentDelimiter>\r</segmentDelimiter>
            <successfulACKCode>AA</successfulACKCode>
            <successfulACKMessage></successfulACKMessage>
            <errorACKCode>AE</errorACKCode>
            <errorACKMessage>An Error Occurred Processing Message.</errorACKMessage>
            <rejectedACKCode>AR</rejectedACKCode>
            <rejectedACKMessage>Message Rejected.</rejectedACKMessage>
            <msh15ACKAccept>false</msh15ACKAccept>
            <dateFormat>yyyyMMddHHmmss.SSS</dateFormat>
          </responseGenerationProperties>
          <responseValidationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseValidationProperties" version="4.4.0">
            <successfulACKCode>AA,CA</successfulACKCode>
            <errorACKCode>AE,CE</errorACKCode>
            <rejectedACKCode>AR,CR</rejectedACKCode>
            <validateMessageControlId>true</validateMessageControlId>
            <originalMessageControlId>Destination_Encoded</originalMessageControlId>
            <originalIdMapVariable></originalIdMapVariable>
          </responseValidationProperties>
        </inboundProperties>
        <outboundProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DataTypeProperties" version="4.4.0">
          <serializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2SerializationProperties" version="4.4.0">
            <handleRepetitions>true</handleRepetitions>
            <handleSubcomponents>true</handleSubcomponents>
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <stripNamespaces>false</stripNamespaces>
            <segmentDelimiter>\r</segmentDelimiter>
            <convertLineBreaks>true</convertLineBreaks>
          </serializationProperties>
          <deserializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DeserializationProperties" version="4.4.0">
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <segmentDelimiter>\r</segmentDelimiter>
          </deserializationProperties>
          <batchProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2BatchProperties" version="4.4.0">
            <splitType>MSH_Segment</splitType>
            <batchScript></batchScript>
          </batchProperties>
          <responseGenerationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseGenerationProperties" version="4.4.0">
            <segmentDelimiter>\r</segmentDelimiter>
            <successfulACKCode>AA</successfulACKCode>
            <successfulACKMessage></successfulACKMessage>
            <errorACKCode>AE</errorACKCode>
            <errorACKMessage>An Error Occurred Processing Message.</errorACKMessage>
            <rejectedACKCode>AR</rejectedACKCode>
            <rejectedACKMessage>Message Rejected.</rejectedACKMessage>
            <msh15ACKAccept>false</msh15ACKAccept>
            <dateFormat>yyyyMMddHHmmss.SSS</dateFormat>
          </responseGenerationProperties>
          <responseValidationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseValidationProperties" version="4.4.0">
            <successfulACKCode>AA,CA</successfulACKCode>
            <errorACKCode>AE,CE</errorACKCode>
            <rejectedACKCode>AR,CR</rejectedACKCode>
            <validateMessageControlId>true</validateMessageControlId>
            <originalMessageControlId>Destination_Encoded</originalMessageControlId>
            <originalIdMapVariable></originalIdMapVariable>
          </responseValidationProperties>
        </outboundProperties>
      </transformer>
      <responseTransformer version="4.4.0">
        <elements/>
        <inboundDataType>HL7V2</inboundDataType>
        <outboundDataType>HL7V2</outboundDataType>
        <inboundProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DataTypeProperties" version="4.4.0">
          <serializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2SerializationProperties" version="4.4.0">
            <handleRepetitions>true</handleRepetitions>
            <handleSubcomponents>true</handleSubcomponents>
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <stripNamespaces>false</stripNamespaces>
            <segmentDelimiter>\r</segmentDelimiter>
            <convertLineBreaks>true</convertLineBreaks>
          </serializationProperties>
          <deserializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DeserializationProperties" version="4.4.0">
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <segmentDelimiter>\r</segmentDelimiter>
          </deserializationProperties>
          <batchProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2BatchProperties" version="4.4.0">
            <splitType>MSH_Segment</splitType>
            <batchScript></batchScript>
          </batchProperties>
          <responseGenerationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseGenerationProperties" version="4.4.0">
            <segmentDelimiter>\r</segmentDelimiter>
            <successfulACKCode>AA</successfulACKCode>
            <successfulACKMessage></successfulACKMessage>
            <errorACKCode>AE</errorACKCode>
            <errorACKMessage>An Error Occurred Processing Message.</errorACKMessage>
            <rejectedACKCode>AR</rejectedACKCode>
            <rejectedACKMessage>Message Rejected.</rejectedACKMessage>
            <msh15ACKAccept>false</msh15ACKAccept>
            <dateFormat>yyyyMMddHHmmss.SSS</dateFormat>
          </responseGenerationProperties>
          <responseValidationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseValidationProperties" version="4.4.0">
            <successfulACKCode>AA,CA</successfulACKCode>
            <errorACKCode>AE,CE</errorACKCode>
            <rejectedACKCode>AR,CR</rejectedACKCode>
            <validateMessageControlId>true</validateMessageControlId>
            <originalMessageControlId>Destination_Encoded</originalMessageControlId>
            <originalIdMapVariable></originalIdMapVariable>
          </responseValidationProperties>
        </inboundProperties>
        <outboundProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DataTypeProperties" version="4.4.0">
          <serializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2SerializationProperties" version="4.4.0">
            <handleRepetitions>true</handleRepetitions>
            <handleSubcomponents>true</handleSubcomponents>
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <stripNamespaces>false</stripNamespaces>
            <segmentDelimiter>\r</segmentDelimiter>
            <convertLineBreaks>true</convertLineBreaks>
          </serializationProperties>
          <deserializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DeserializationProperties" version="4.4.0">
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <segmentDelimiter>\r</segmentDelimiter>
          </deserializationProperties>
          <batchProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2BatchProperties" version="4.4.0">
            <splitType>MSH_Segment</splitType>
            <batchScript></batchScript>
          </batchProperties>
          <responseGenerationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseGenerationProperties" version="4.4.0">
            <segmentDelimiter>\r</segmentDelimiter>
            <successfulACKCode>AA</successfulACKCode>
            <successfulACKMessage></successfulACKMessage>
            <errorACKCode>AE</errorACKCode>
            <errorACKMessage>An Error Occurred Processing Message.</errorACKMessage>
            <rejectedACKCode>AR</rejectedACKCode>
            <rejectedACKMessage>Message Rejected.</rejectedACKMessage>
            <msh15ACKAccept>false</msh15ACKAccept>
            <dateFormat>yyyyMMddHHmmss.SSS</dateFormat>
          </responseGenerationProperties>
          <responseValidationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseValidationProperties" version="4.4.0">
            <successfulACKCode>AA,CA</successfulACKCode>
            <errorACKCode>AE,CE</errorACKCode>
            <rejectedACKCode>AR,CR</rejectedACKCode>
            <validateMessageControlId>true</validateMessageControlId>
            <originalMessageControlId>Destination_Encoded</originalMessageControlId>
            <originalIdMapVariable></originalIdMapVariable>
          </responseValidationProperties>
        </outboundProperties>
      </responseTransformer>
      <filter version="4.4.0">
        <elements/>
      </filter>
      <transportName>Channel Writer</transportName>
      <mode>DESTINATION</mode>
      <enabled>true</enabled>
      <waitForPrevious>true</waitForPrevious>
    </connector>
    <connector version="4.4.0">
      <metaDataId>2</metaDataId>
      <name>Validate</name>
      <properties class="com.mirth.connect.connectors.vm.VmDispatcherProperties" version="4.4.0">
        <pluginProperties/>
        <destinationConnectorProperties version="4.4.0">
          <queueEnabled>false</queueEnabled>
          <sendFirst>false</sendFirst>
          <retryIntervalMillis>10000</retryIntervalMillis>
          <regenerateTemplate>false</regenerateTemplate>
          <retryCount>0</retryCount>
          <rotate>false</rotate>
          <includeFilterTransformer>false</includeFilterTransformer>
          <threadCount>1</threadCount>
          <threadAssignmentVariable></threadAssignmentVariable>
          <validateResponse>false</validateResponse>
          <resourceIds class="linked-hash-map">
            <entry>
              <string>Default Resource</string>
              <string>[Default Resource]</string>
            </entry>
          </resourceIds>
          <queueBufferSize>1000</queueBufferSize>
          <reattachAttachments>true</reattachAttachments>
        </destinationConnectorProperties>
        <channelId>none</channelId>
        <channelTemplate>${message.encodedData}</channelTemplate>
        <mapVariables/>
      </properties>
      <transformer version="4.4.0">
        <elements>
          <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="4.4.0">
            <name>Get selected patient&apos;s encounter not yet discharged</name>
            <sequenceNumber>0</sequenceNumber>
            <enabled>true</enabled>
            <script>var query = &quot;SELECT [AdmitDateTime], [PatientKey] FROM he.Encounter Where TenantKey=&apos;&quot; 
query += $(&apos;clientId&apos;) + &quot;&apos; AND PatientKey = &apos;&quot; 
query += $(&apos;SelectedPatient&apos;).PatientKey + &quot;&apos; AND [Location]=&apos;&quot; + $(&apos;sendingLocation&apos;) + &quot;&apos;&quot;;

var selectedEncounter = selectQueryBuilder(query);
//logger.debug(&quot;AdmitDateTime: &quot; + selectedEncounter[0].AdmitDateTime)
channelMap.put(&apos;AdmitDateTime&apos;, selectedEncounter[0].AdmitDateTime)
channelMap.put(&apos;EncounterKey&apos;, selectedEncounter[0].EncounterKey)
channelMap.put(&apos;PatientKey&apos;, selectedEncounter[0].PatientKey)</script>
          </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>
        </elements>
        <inboundTemplate encoding="base64">TVNIfF5+XCZ8RUhSfE5vcnRoIEJyb3dhcmQgSG9zcGl0YWx8UkVTVUxUU3xOb3J0aCBCcm93YXJkIEhvc3BpdGFsfDIwMjUxMDE2MTMwMDAwfHxPUlVeUjAxXk9SVV9SMDF8TkJILU9SVS0yMDI1MTAxNi0wMDAzfFB8Mi41ClBJRHwxfHxOQkgwMDAxMjZeXl5OQkheTVJ8fEJyb3duXkxpYW1eS3x8MjAwMTExMzB8TXx8fDgyMCBTVyAxMHRoIFN0Xl5EZWVyZmllbGQgQmVhY2heRkxeMzM0NDFeVVNBfHwrMSg5NTQpNTU1LTA0NDB8fHx8fDk5OS00NS02Nzg5ClBWMXwxfE98T1BEXkNMSU5eMDdeTkJIXl5ST09NfHx8fHxeXl58fHx8fHx8fHxWMDAwNHx8fHx8fHx8fHx8fHx8fHxBfHx8MjAyNTEwMTUxMDU1NDUKT1JDfFJFfFYwMDA0fHx8Ck9CUnwxfFYwMDA0fHwxODg0Mi01XkRpc2NoYXJnZSBzdW1tYXJ5XkxOfFJ8fDIwMjUxMDE1MTA1NTQ1fDIwMjUxMDE2MTI1NTAwfHx8fHx8fHw0MTIwMF5Hb256YWxlel5FbGVuYV5eXk1EXl5OUEl8fHx8fHxGCk9CWHwxfFRYfDE4ODQyLTVeRGlzY2hhcmdlIHN1bW1hcnleTE58fFNlZW4gaW4gY2xpbmljIGZvciBtaWdyYWluZSBleGFjZXJiYXRpb24uIFN5bXB0b21zIGltcHJvdmVkIHdpdGggdGhlcmFweS4gRGlzY2hhcmdlZCB3aXRoIHByZXZlbnRpdmUgcmVnaW1lbiBhbmQgbmV1cm9sb2d5IGZvbGxvdy11cC58Tnx8fHx8MjAyNTEwMTYxMzAwMDAKT0JYfDJ8VFh8QURNX0RPQ15BZG1pdHRpbmcgZG9jdG9yXkx8fDQxMjAwXkdvbnphbGV6XkVsZW5hXl5eTUReXk5QSXxOCk9CWHwzfFRYfENPTlNfRE9DXkNvbnN1bHRpbmcgZG9jdG9yXkx8fE5vbmUgcmVjb3JkZWR8TgpPQlh8NHxUWHxESVNfRE9DXkRpc2NoYXJnZSBkb2N0b3JeTHx8NDEyMDBeR29uemFsZXpeRWxlbmFeXl5NRF5eTlBJfE4K</inboundTemplate>
        <outboundTemplate encoding="base64"></outboundTemplate>
        <inboundDataType>HL7V2</inboundDataType>
        <outboundDataType>HL7V2</outboundDataType>
        <inboundProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DataTypeProperties" version="4.4.0">
          <serializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2SerializationProperties" version="4.4.0">
            <handleRepetitions>true</handleRepetitions>
            <handleSubcomponents>true</handleSubcomponents>
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <stripNamespaces>false</stripNamespaces>
            <segmentDelimiter>\r</segmentDelimiter>
            <convertLineBreaks>true</convertLineBreaks>
          </serializationProperties>
          <deserializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DeserializationProperties" version="4.4.0">
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <segmentDelimiter>\r</segmentDelimiter>
          </deserializationProperties>
          <batchProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2BatchProperties" version="4.4.0">
            <splitType>MSH_Segment</splitType>
            <batchScript></batchScript>
          </batchProperties>
          <responseGenerationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseGenerationProperties" version="4.4.0">
            <segmentDelimiter>\r</segmentDelimiter>
            <successfulACKCode>AA</successfulACKCode>
            <successfulACKMessage></successfulACKMessage>
            <errorACKCode>AE</errorACKCode>
            <errorACKMessage>An Error Occurred Processing Message.</errorACKMessage>
            <rejectedACKCode>AR</rejectedACKCode>
            <rejectedACKMessage>Message Rejected.</rejectedACKMessage>
            <msh15ACKAccept>false</msh15ACKAccept>
            <dateFormat>yyyyMMddHHmmss.SSS</dateFormat>
          </responseGenerationProperties>
          <responseValidationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseValidationProperties" version="4.4.0">
            <successfulACKCode>AA,CA</successfulACKCode>
            <errorACKCode>AE,CE</errorACKCode>
            <rejectedACKCode>AR,CR</rejectedACKCode>
            <validateMessageControlId>true</validateMessageControlId>
            <originalMessageControlId>Destination_Encoded</originalMessageControlId>
            <originalIdMapVariable></originalIdMapVariable>
          </responseValidationProperties>
        </inboundProperties>
        <outboundProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DataTypeProperties" version="4.4.0">
          <serializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2SerializationProperties" version="4.4.0">
            <handleRepetitions>true</handleRepetitions>
            <handleSubcomponents>true</handleSubcomponents>
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <stripNamespaces>false</stripNamespaces>
            <segmentDelimiter>\r</segmentDelimiter>
            <convertLineBreaks>true</convertLineBreaks>
          </serializationProperties>
          <deserializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DeserializationProperties" version="4.4.0">
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <segmentDelimiter>\r</segmentDelimiter>
          </deserializationProperties>
          <batchProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2BatchProperties" version="4.4.0">
            <splitType>MSH_Segment</splitType>
            <batchScript></batchScript>
          </batchProperties>
          <responseGenerationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseGenerationProperties" version="4.4.0">
            <segmentDelimiter>\r</segmentDelimiter>
            <successfulACKCode>AA</successfulACKCode>
            <successfulACKMessage></successfulACKMessage>
            <errorACKCode>AE</errorACKCode>
            <errorACKMessage>An Error Occurred Processing Message.</errorACKMessage>
            <rejectedACKCode>AR</rejectedACKCode>
            <rejectedACKMessage>Message Rejected.</rejectedACKMessage>
            <msh15ACKAccept>false</msh15ACKAccept>
            <dateFormat>yyyyMMddHHmmss.SSS</dateFormat>
          </responseGenerationProperties>
          <responseValidationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseValidationProperties" version="4.4.0">
            <successfulACKCode>AA,CA</successfulACKCode>
            <errorACKCode>AE,CE</errorACKCode>
            <rejectedACKCode>AR,CR</rejectedACKCode>
            <validateMessageControlId>true</validateMessageControlId>
            <originalMessageControlId>Destination_Encoded</originalMessageControlId>
            <originalIdMapVariable></originalIdMapVariable>
          </responseValidationProperties>
        </outboundProperties>
      </transformer>
      <responseTransformer version="4.4.0">
        <elements/>
        <inboundDataType>HL7V2</inboundDataType>
        <outboundDataType>HL7V2</outboundDataType>
        <inboundProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DataTypeProperties" version="4.4.0">
          <serializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2SerializationProperties" version="4.4.0">
            <handleRepetitions>true</handleRepetitions>
            <handleSubcomponents>true</handleSubcomponents>
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <stripNamespaces>false</stripNamespaces>
            <segmentDelimiter>\r</segmentDelimiter>
            <convertLineBreaks>true</convertLineBreaks>
          </serializationProperties>
          <deserializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DeserializationProperties" version="4.4.0">
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <segmentDelimiter>\r</segmentDelimiter>
          </deserializationProperties>
          <batchProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2BatchProperties" version="4.4.0">
            <splitType>MSH_Segment</splitType>
            <batchScript></batchScript>
          </batchProperties>
          <responseGenerationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseGenerationProperties" version="4.4.0">
            <segmentDelimiter>\r</segmentDelimiter>
            <successfulACKCode>AA</successfulACKCode>
            <successfulACKMessage></successfulACKMessage>
            <errorACKCode>AE</errorACKCode>
            <errorACKMessage>An Error Occurred Processing Message.</errorACKMessage>
            <rejectedACKCode>AR</rejectedACKCode>
            <rejectedACKMessage>Message Rejected.</rejectedACKMessage>
            <msh15ACKAccept>false</msh15ACKAccept>
            <dateFormat>yyyyMMddHHmmss.SSS</dateFormat>
          </responseGenerationProperties>
          <responseValidationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseValidationProperties" version="4.4.0">
            <successfulACKCode>AA,CA</successfulACKCode>
            <errorACKCode>AE,CE</errorACKCode>
            <rejectedACKCode>AR,CR</rejectedACKCode>
            <validateMessageControlId>true</validateMessageControlId>
            <originalMessageControlId>Destination_Encoded</originalMessageControlId>
            <originalIdMapVariable></originalIdMapVariable>
          </responseValidationProperties>
        </inboundProperties>
        <outboundProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DataTypeProperties" version="4.4.0">
          <serializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2SerializationProperties" version="4.4.0">
            <handleRepetitions>true</handleRepetitions>
            <handleSubcomponents>true</handleSubcomponents>
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <stripNamespaces>false</stripNamespaces>
            <segmentDelimiter>\r</segmentDelimiter>
            <convertLineBreaks>true</convertLineBreaks>
          </serializationProperties>
          <deserializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DeserializationProperties" version="4.4.0">
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <segmentDelimiter>\r</segmentDelimiter>
          </deserializationProperties>
          <batchProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2BatchProperties" version="4.4.0">
            <splitType>MSH_Segment</splitType>
            <batchScript></batchScript>
          </batchProperties>
          <responseGenerationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseGenerationProperties" version="4.4.0">
            <segmentDelimiter>\r</segmentDelimiter>
            <successfulACKCode>AA</successfulACKCode>
            <successfulACKMessage></successfulACKMessage>
            <errorACKCode>AE</errorACKCode>
            <errorACKMessage>An Error Occurred Processing Message.</errorACKMessage>
            <rejectedACKCode>AR</rejectedACKCode>
            <rejectedACKMessage>Message Rejected.</rejectedACKMessage>
            <msh15ACKAccept>false</msh15ACKAccept>
            <dateFormat>yyyyMMddHHmmss.SSS</dateFormat>
          </responseGenerationProperties>
          <responseValidationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseValidationProperties" version="4.4.0">
            <successfulACKCode>AA,CA</successfulACKCode>
            <errorACKCode>AE,CE</errorACKCode>
            <rejectedACKCode>AR,CR</rejectedACKCode>
            <validateMessageControlId>true</validateMessageControlId>
            <originalMessageControlId>Destination_Encoded</originalMessageControlId>
            <originalIdMapVariable></originalIdMapVariable>
          </responseValidationProperties>
        </outboundProperties>
      </responseTransformer>
      <filter version="4.4.0">
        <elements/>
      </filter>
      <transportName>Channel Writer</transportName>
      <mode>DESTINATION</mode>
      <enabled>true</enabled>
      <waitForPrevious>true</waitForPrevious>
    </connector>
    <connector version="4.4.0">
      <metaDataId>4</metaDataId>
      <name>Upsert Encounter</name>
      <properties class="com.mirth.connect.connectors.vm.VmDispatcherProperties" version="4.4.0">
        <pluginProperties/>
        <destinationConnectorProperties version="4.4.0">
          <queueEnabled>false</queueEnabled>
          <sendFirst>false</sendFirst>
          <retryIntervalMillis>10000</retryIntervalMillis>
          <regenerateTemplate>false</regenerateTemplate>
          <retryCount>0</retryCount>
          <rotate>false</rotate>
          <includeFilterTransformer>false</includeFilterTransformer>
          <threadCount>1</threadCount>
          <threadAssignmentVariable></threadAssignmentVariable>
          <validateResponse>false</validateResponse>
          <resourceIds class="linked-hash-map">
            <entry>
              <string>Default Resource</string>
              <string>[Default Resource]</string>
            </entry>
          </resourceIds>
          <queueBufferSize>1000</queueBufferSize>
          <reattachAttachments>true</reattachAttachments>
        </destinationConnectorProperties>
        <channelId>none</channelId>
        <channelTemplate>${message.encodedData}</channelTemplate>
        <mapVariables/>
      </properties>
      <transformer version="4.4.0">
        <elements>
          <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="4.4.0">
            <name>Helper</name>
            <sequenceNumber>0</sequenceNumber>
            <enabled>true</enabled>
            <script>// ===== helpers ==============================================================
function get(path, dflt) {
  try {
    var v = path.toString();
    return (v == null || v === &apos;&apos;) ? (dflt || &apos;&apos;) : v;
  } catch (e) {
    return dflt || &apos;&apos;;
  }
}
function parseTS(ts) {
  // HL7 TS → &apos;YYYY-MM-DDTHH:MM:SS&apos;
  ts = (ts || &apos;&apos;).trim();
  if (!ts) return &apos;&apos;;
  var y = ts.substring(0,4), m = ts.substring(4,6), d = ts.substring(6,8);
  var hh = ts.length &gt;= 10 ? ts.substring(8,10) : &apos;00&apos;;
  var mm = ts.length &gt;= 12 ? ts.substring(10,12) : &apos;00&apos;;
  var ss = ts.length &gt;= 14 ? ts.substring(12,14) : &apos;00&apos;;
  if (!y || !m || !d) return &apos;&apos;;
  return y + &apos;-&apos; + m + &apos;-&apos; + d + &apos;T&apos; + hh + &apos;:&apos; + mm + &apos;:&apos; + ss;
}
function formatLoc(pv1_3) {
  // PV1-3: pointOfCare^room^bed^facility^^type
  var poc = get(pv1_3[&apos;PV1.3.1&apos;]);
  var room = get(pv1_3[&apos;PV1.3.2&apos;]);
  var bed  = get(pv1_3[&apos;PV1.3.3&apos;]);
  var fac  = get(pv1_3[&apos;PV1.3.4&apos;]);
  var typ  = get(pv1_3[&apos;PV1.3.6&apos;]);
  var left = [poc, room, bed].filter(Boolean).join(&apos;-&apos;);
  var parts = [];
  if (left) parts.push(left);
  if (fac) parts.push(&apos;@ &apos; + fac);
  if (typ) parts.push(&apos;(&apos; + typ + &apos;)&apos;);
  return parts.join(&apos; &apos;);
}
function formatXCN(xcn) {
  if (!xcn) return &apos;&apos;;
  var id  = get(xcn[&apos;XCN.1&apos;]);
  var fam = get(xcn[&apos;XCN.2&apos;]);
  var giv = get(xcn[&apos;XCN.3&apos;]);
  var mid = get(xcn[&apos;XCN.4&apos;]);
  var deg = get(xcn[&apos;XCN.6&apos;]);
  var name = [giv, mid, fam].filter(Boolean).join(&apos; &apos;).replace(/\s+/g,&apos; &apos;).trim();
  var label = name || (fam || giv || &apos;&apos;);
  var suffix = [];
  if (deg) suffix.push(deg);
  if (id)  suffix.push(&apos;(&apos; + id + &apos;)&apos;);
  return (label + (suffix.length ? &apos; &apos; + suffix.join(&apos; &apos;) : &apos;&apos;)).trim();
}

function TCMDates(dischargeDateTime) {
    var TCM = { TcmSchedule1: null, TcmSchedule2: null };
    if (!dischargeDateTime) return TCM;

    var SimpleDateFormat = Packages.java.text.SimpleDateFormat;
    var Calendar         = Packages.java.util.Calendar;
    var TimeZone         = Packages.java.util.TimeZone;

    // Try both patterns (with T and with space)
    var patterns = [&quot;yyyy-MM-dd&apos;T&apos;HH:mm:ss&quot;, &quot;yyyy-MM-dd HH:mm:ss&quot;];
    var parsed = null;

    for (var i = 0; i &lt; patterns.length &amp;&amp; parsed == null; i++) {
        var fmt = new SimpleDateFormat(patterns[i]);
        fmt.setLenient(false);
        // Optional: set a timezone if desired (comment out if you want server local time)
        // fmt.setTimeZone(TimeZone.getTimeZone(&quot;UTC&quot;));
        try {
            parsed = fmt.parse(String(dischargeDateTime));
        } catch (e) {
            // try next pattern
        }
    }

    if (parsed == null) {
        logger.warn(&apos;Invalid DischargeDateTime for TCM schedule calculation: &apos; + dischargeDateTime);
        return TCM;
    }

    // Use Calendar to add days
    var cal1 = Calendar.getInstance();
    cal1.setTime(parsed);
    cal1.add(Calendar.DAY_OF_MONTH, 7);

    var cal2 = Calendar.getInstance();
    cal2.setTime(parsed);
    cal2.add(Calendar.DAY_OF_MONTH, 15);

    // Output format (ISO-like)
    var outFmt = new SimpleDateFormat(&quot;yyyy-MM-dd&apos;T&apos;HH:mm:ss&quot;);
    // Optional: keep same timezone as above if you set one
    // outFmt.setTimeZone(TimeZone.getTimeZone(&quot;UTC&quot;));

    TCM.TcmSchedule1 = outFmt.format(cal1.getTime());
    TCM.TcmSchedule2 = outFmt.format(cal2.getTime());
    return TCM;
}</script>
          </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>
          <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="4.4.0">
            <name>Mapping encounter for update</name>
            <sequenceNumber>1</sequenceNumber>
            <enabled>true</enabled>
            <script>// ===== pointers =============================================================
var msh = msg[&apos;MSH&apos;];
var evn = msg[&apos;EVN&apos;];
var pv1 = msg[&apos;PV1&apos;];
var orc = msg[&apos;ORC&apos;];
var obr = msg[&apos;OBR&apos;];
// OBX segments parsed via your mapDischargeOBX(), producing channelMap values

// ===== derive encounter fields from ORU =====================================

// VisitNumber: prefer OBR-2 or ORC-2, fallback PV1-19
var visitNumber =
  get(obr[&apos;OBR.2&apos;][&apos;OBR.2.1&apos;]) ||
  get(orc[&apos;ORC.2&apos;][&apos;ORC.2.1&apos;]) ||
  get(pv1[&apos;PV1.19&apos;][&apos;PV1.19.1&apos;]); // e.g., V0001

// Class/location same as ADT (present in ORU here)
var patientClass = get(pv1[&apos;PV1.2&apos;][&apos;PV1.2.1&apos;]); // I/O/E
var locationStr  = formatLoc(pv1[&apos;PV1.3&apos;]);

// Admit datetime (kept from existing encounter; fallback via EVN/OBR if needed)
var admitDTExisting = $(&apos;AdmitDateTime&apos;); // already stored during A01 flow
var admitDTFromEVN  = parseTS(get(evn[&apos;EVN.2&apos;][&apos;EVN.2.1&apos;]));
var admitDateTime   = $(&apos;AdmitDateTime&apos;) //admitDTExisting || admitDTFromEVN || null;

// Discharge datetime (prefer clinical doc time; ORU has both)
var dischargeDTFromOBX14 = parseTS(get(msg[&apos;OBX&apos;][&apos;OBX.14&apos;][&apos;OBX.14.1&apos;])); // if a single OBX pointer is used
// If multiple OBXs exist, the above may not work; you already call mapDischargeOBX(), which captures times if needed.
// OBR-8 is &quot;Observation End Date/Time&quot; → reasonable proxy for discharge summary time
var dischargeDTFromOBR8  = parseTS(get(obr[&apos;OBR.8&apos;][&apos;OBR.8.1&apos;]));
var dischargeDateTime    = dischargeDTFromOBX14 || dischargeDTFromOBR8 || null;

// Admit/Discharge message IDs
var dischargeMessageId = get(msh[&apos;MSH.10&apos;][&apos;MSH.10.1&apos;]); // NBH-ORU-20251016-0001

// Doctors from OBX (already parsed into channelMap by your helper)
mapDischargeOBX(msg);
cleanMappedDischargeFields();
var noteTxt          = channelMap.get(&apos;Note&apos;);               // OBX-1 discharge summary text
var admittingDoctor  = channelMap.get(&apos;AdmittingDoctor&apos;);    // from ADM_DOC
var consultingDoctor = channelMap.get(&apos;ConsultingDoctor&apos;);   // from CONS_DOC (can be &apos;None recorded&apos;)
var dischargeDoctor  = channelMap.get(&apos;DischargeDoctor&apos;);    // from DIS_DOC

// Build friendly strings when map function not used:
if (!admittingDoctor) {
  // Fallback: OBR-16 ordering provider sometimes carries discharging doc in discharge summaries
  admittingDoctor = formatXCN(obr[&apos;OBR.16&apos;]);
}

// Visit status — for an ORU discharge summary, mark as Discharged
var visitStatus = &apos;Discharged&apos;;

// Admit source may not be present in ORU; keep existing if we have it
var admitSourceExisting = get(pv1[&apos;PV1.14&apos;][&apos;PV1.14.1&apos;]) || null;

// ===== build encounter object ===============================================

var encounter = {};
encounter.TenantKey  = $(&apos;clientId&apos;);
encounter.HospitalKey = 1;
encounter.PatientKey = $(&apos;PatientKey&apos;);

// IMPORTANT: use true visit number (e.g., &apos;V0001&apos;), not numeric 1
encounter.VisitNumber = visitNumber || null;


// Keep/refresh core fields
encounter.AdmitDateTime     = admitDateTime;
encounter.DischargeDateTime = dischargeDateTime;

encounter.PatientClass = patientClass || null;
encounter.Location     = $(&apos;sendingLocation&apos;) || locationStr;

// Admission details (keep existing if source empty)
encounter.AdmitType   = get(pv1[&apos;PV1.4&apos;][&apos;PV1.4.1&apos;]) || null;
encounter.AdmitSource = admitSourceExisting;

// Providers (free-text display; keys resolved by separate provider-upsert)
encounter.AttendingDoctor = (consultingDoctor &amp;&amp; consultingDoctor !== &apos;None recorded&apos;) ? consultingDoctor : null;
encounter.AdmittingDoctor = admittingDoctor || null;
// PrimaryDoctor: DO NOT hardcode; leave null to preserve prior value in MERGE via COALESCE
encounter.PrimaryDoctor   = null;

// Messages
encounter.AdmitMessageId     = null; // unchanged by ORU
encounter.DischargeMessageId = dischargeMessageId || null;

// Discharge/diagnosis (no coded dx in this ORU)
encounter.DischargeDispositionCode = null;
encounter.PrincipalDiagnosisCode   = null;

// Clinical notes
encounter.Notes = noteTxt || null;

// Care transitions placeholders (leave null; your workflows will fill later)
encounter.ObservationFlag         = (patientClass === &apos;O&apos;) ? 1 : 0;
encounter.FollowUpProviderKey     = null;
encounter.FollowUpApptDateTime    = null;
encounter.CommunicationSentDate   = null;
encounter.TCMContactDate          = null;
encounter.TCMMethod               = null;
encounter.HandoffAcknowledgedDate = null;
encounter.ReadmissionSourceEncKey = null;

// Payer context (not in this ORU; keep null so MERGE COALESCE preserves existing)
encounter.PayerName = null;
encounter.MemberId  = null;

// Provider FK placeholders (resolved elsewhere)
encounter.AttendingProviderKey = null;
encounter.AdmittingProviderKey = null;
encounter.DischargeProviderKey = null;

// Status stays 1 (active) by default
encounter.Status = 1;
encounter.VisitStatus = visitStatus;

var tcm = TCMDates(encounter.DischargeDateTime);
encounter.TcmSchedule1 = tcm.TcmSchedule1;
encounter.TcmSchedule2 = tcm.TcmSchedule2;


// ===== persist via MERGE-based updater ======================================
channelMap.put(&apos;encounterJson&apos;, JSON.stringify(encounter));
logger.debug(&apos;encounter (from ORU) → &apos; + JSON.stringify(encounter, null, 2));

// Your MERGE-based function from earlier (matching Option A: include PatientKey!)
upsertEncounter(encounter);</script>
          </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>
        </elements>
        <inboundTemplate encoding="base64">TVNIfF5+XCZ8RUhSfE5vcnRoIEJyb3dhcmQgSG9zcGl0YWx8UkVTVUxUU3xOb3J0aCBCcm93YXJkIEhvc3BpdGFsfDIwMjUxMDE2MTIwMDAwfHxPUlVeUjAxXk9SVV9SMDF8TkJILU9SVS0yMDI1MTAxNi0wMDAxfFB8Mi41ClBJRHwxfHxOQkgwMDAxMjNeXl5OQkheTVJ8fFJpdmVyYV5DYW1pbGFeU3x8MTk5MDA2MjF8Rnx8fDc0MiBORSAzcmQgQXZlXl5Gb3J0IExhdWRlcmRhbGVeRkxeMzMzMDReVVNBfHwrMSg5NTQpNTU1LTAxMjN8fHx8fDk5OS0xMi0zNDU2ClBWMXwxfEl8M05eMzEyXkJeTkJIXl5CRUR8fHx8fF5eXnx8fHx8fHx8fFYwMDAxfHx8fHx8fHx8fHx8fHx8fEF8fHwyMDI1MTAxNTEwMTUwMApPUkN8UkV8VjAwMDF8fHwKT0JSfDF8VjAwMDF8fDE4ODQyLTVeRGlzY2hhcmdlIHN1bW1hcnleTE58Unx8MjAyNTEwMTUxMDE1MDB8MjAyNTEwMTYxMTU5MDB8fHx8fHx8fDEyMzQ1Xkhlcm5hbmRlel5NYXJpYV5KXl5NRF5eTlBJfHx8fHx8RgpPQlh8MXxUWHwxODg0Mi01XkRpc2NoYXJnZSBzdW1tYXJ5XkxOfHxQYXRpZW50IGFkbWl0dGVkIGZvciBvYnNlcnZhdGlvbiBhZnRlciBtaW5vciBoZWFkIGluanVyeS4gQ1QgbmVnYXRpdmUuIFBhaW4gY29udHJvbGxlZC4gRGlzY2hhcmdlIGhvbWUgd2l0aCBpbnN0cnVjdGlvbnMgYW5kIGZvbGxvdy11cCBpbiAxIHdlZWsufE58fHx8fDIwMjUxMDE2MTIwMDAwCk9CWHwyfFRYfEFETV9ET0NeQWRtaXR0aW5nIGRvY3Rvcl5MfHwxMjM0NV5IZXJuYW5kZXpeTWFyaWFeSl5eTUReXk5QSXxOCk9CWHwzfFRYfENPTlNfRE9DXkNvbnN1bHRpbmcgZG9jdG9yXkx8fE5vbmUgcmVjb3JkZWR8TgpPQlh8NHxUWHxESVNfRE9DXkRpc2NoYXJnZSBkb2N0b3JeTHx8MTIzNDVeSGVybmFuZGV6Xk1hcmlhXkpeXk1EXl5OUEl8Tgo=</inboundTemplate>
        <outboundTemplate encoding="base64"></outboundTemplate>
        <inboundDataType>HL7V2</inboundDataType>
        <outboundDataType>HL7V2</outboundDataType>
        <inboundProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DataTypeProperties" version="4.4.0">
          <serializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2SerializationProperties" version="4.4.0">
            <handleRepetitions>true</handleRepetitions>
            <handleSubcomponents>true</handleSubcomponents>
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <stripNamespaces>false</stripNamespaces>
            <segmentDelimiter>\r</segmentDelimiter>
            <convertLineBreaks>true</convertLineBreaks>
          </serializationProperties>
          <deserializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DeserializationProperties" version="4.4.0">
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <segmentDelimiter>\r</segmentDelimiter>
          </deserializationProperties>
          <batchProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2BatchProperties" version="4.4.0">
            <splitType>MSH_Segment</splitType>
            <batchScript></batchScript>
          </batchProperties>
          <responseGenerationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseGenerationProperties" version="4.4.0">
            <segmentDelimiter>\r</segmentDelimiter>
            <successfulACKCode>AA</successfulACKCode>
            <successfulACKMessage></successfulACKMessage>
            <errorACKCode>AE</errorACKCode>
            <errorACKMessage>An Error Occurred Processing Message.</errorACKMessage>
            <rejectedACKCode>AR</rejectedACKCode>
            <rejectedACKMessage>Message Rejected.</rejectedACKMessage>
            <msh15ACKAccept>false</msh15ACKAccept>
            <dateFormat>yyyyMMddHHmmss.SSS</dateFormat>
          </responseGenerationProperties>
          <responseValidationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseValidationProperties" version="4.4.0">
            <successfulACKCode>AA,CA</successfulACKCode>
            <errorACKCode>AE,CE</errorACKCode>
            <rejectedACKCode>AR,CR</rejectedACKCode>
            <validateMessageControlId>true</validateMessageControlId>
            <originalMessageControlId>Destination_Encoded</originalMessageControlId>
            <originalIdMapVariable></originalIdMapVariable>
          </responseValidationProperties>
        </inboundProperties>
        <outboundProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DataTypeProperties" version="4.4.0">
          <serializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2SerializationProperties" version="4.4.0">
            <handleRepetitions>true</handleRepetitions>
            <handleSubcomponents>true</handleSubcomponents>
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <stripNamespaces>false</stripNamespaces>
            <segmentDelimiter>\r</segmentDelimiter>
            <convertLineBreaks>true</convertLineBreaks>
          </serializationProperties>
          <deserializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DeserializationProperties" version="4.4.0">
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <segmentDelimiter>\r</segmentDelimiter>
          </deserializationProperties>
          <batchProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2BatchProperties" version="4.4.0">
            <splitType>MSH_Segment</splitType>
            <batchScript></batchScript>
          </batchProperties>
          <responseGenerationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseGenerationProperties" version="4.4.0">
            <segmentDelimiter>\r</segmentDelimiter>
            <successfulACKCode>AA</successfulACKCode>
            <successfulACKMessage></successfulACKMessage>
            <errorACKCode>AE</errorACKCode>
            <errorACKMessage>An Error Occurred Processing Message.</errorACKMessage>
            <rejectedACKCode>AR</rejectedACKCode>
            <rejectedACKMessage>Message Rejected.</rejectedACKMessage>
            <msh15ACKAccept>false</msh15ACKAccept>
            <dateFormat>yyyyMMddHHmmss.SSS</dateFormat>
          </responseGenerationProperties>
          <responseValidationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseValidationProperties" version="4.4.0">
            <successfulACKCode>AA,CA</successfulACKCode>
            <errorACKCode>AE,CE</errorACKCode>
            <rejectedACKCode>AR,CR</rejectedACKCode>
            <validateMessageControlId>true</validateMessageControlId>
            <originalMessageControlId>Destination_Encoded</originalMessageControlId>
            <originalIdMapVariable></originalIdMapVariable>
          </responseValidationProperties>
        </outboundProperties>
      </transformer>
      <responseTransformer version="4.4.0">
        <elements/>
        <inboundDataType>HL7V2</inboundDataType>
        <outboundDataType>HL7V2</outboundDataType>
        <inboundProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DataTypeProperties" version="4.4.0">
          <serializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2SerializationProperties" version="4.4.0">
            <handleRepetitions>true</handleRepetitions>
            <handleSubcomponents>true</handleSubcomponents>
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <stripNamespaces>false</stripNamespaces>
            <segmentDelimiter>\r</segmentDelimiter>
            <convertLineBreaks>true</convertLineBreaks>
          </serializationProperties>
          <deserializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DeserializationProperties" version="4.4.0">
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <segmentDelimiter>\r</segmentDelimiter>
          </deserializationProperties>
          <batchProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2BatchProperties" version="4.4.0">
            <splitType>MSH_Segment</splitType>
            <batchScript></batchScript>
          </batchProperties>
          <responseGenerationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseGenerationProperties" version="4.4.0">
            <segmentDelimiter>\r</segmentDelimiter>
            <successfulACKCode>AA</successfulACKCode>
            <successfulACKMessage></successfulACKMessage>
            <errorACKCode>AE</errorACKCode>
            <errorACKMessage>An Error Occurred Processing Message.</errorACKMessage>
            <rejectedACKCode>AR</rejectedACKCode>
            <rejectedACKMessage>Message Rejected.</rejectedACKMessage>
            <msh15ACKAccept>false</msh15ACKAccept>
            <dateFormat>yyyyMMddHHmmss.SSS</dateFormat>
          </responseGenerationProperties>
          <responseValidationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseValidationProperties" version="4.4.0">
            <successfulACKCode>AA,CA</successfulACKCode>
            <errorACKCode>AE,CE</errorACKCode>
            <rejectedACKCode>AR,CR</rejectedACKCode>
            <validateMessageControlId>true</validateMessageControlId>
            <originalMessageControlId>Destination_Encoded</originalMessageControlId>
            <originalIdMapVariable></originalIdMapVariable>
          </responseValidationProperties>
        </inboundProperties>
        <outboundProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DataTypeProperties" version="4.4.0">
          <serializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2SerializationProperties" version="4.4.0">
            <handleRepetitions>true</handleRepetitions>
            <handleSubcomponents>true</handleSubcomponents>
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <stripNamespaces>false</stripNamespaces>
            <segmentDelimiter>\r</segmentDelimiter>
            <convertLineBreaks>true</convertLineBreaks>
          </serializationProperties>
          <deserializationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2DeserializationProperties" version="4.4.0">
            <useStrictParser>false</useStrictParser>
            <useStrictValidation>false</useStrictValidation>
            <segmentDelimiter>\r</segmentDelimiter>
          </deserializationProperties>
          <batchProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2BatchProperties" version="4.4.0">
            <splitType>MSH_Segment</splitType>
            <batchScript></batchScript>
          </batchProperties>
          <responseGenerationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseGenerationProperties" version="4.4.0">
            <segmentDelimiter>\r</segmentDelimiter>
            <successfulACKCode>AA</successfulACKCode>
            <successfulACKMessage></successfulACKMessage>
            <errorACKCode>AE</errorACKCode>
            <errorACKMessage>An Error Occurred Processing Message.</errorACKMessage>
            <rejectedACKCode>AR</rejectedACKCode>
            <rejectedACKMessage>Message Rejected.</rejectedACKMessage>
            <msh15ACKAccept>false</msh15ACKAccept>
            <dateFormat>yyyyMMddHHmmss.SSS</dateFormat>
          </responseGenerationProperties>
          <responseValidationProperties class="com.mirth.connect.plugins.datatypes.hl7v2.HL7v2ResponseValidationProperties" version="4.4.0">
            <successfulACKCode>AA,CA</successfulACKCode>
            <errorACKCode>AE,CE</errorACKCode>
            <rejectedACKCode>AR,CR</rejectedACKCode>
            <validateMessageControlId>true</validateMessageControlId>
            <originalMessageControlId>Destination_Encoded</originalMessageControlId>
            <originalIdMapVariable></originalIdMapVariable>
          </responseValidationProperties>
        </outboundProperties>
      </responseTransformer>
      <filter version="4.4.0">
        <elements/>
      </filter>
      <transportName>Channel Writer</transportName>
      <mode>DESTINATION</mode>
      <enabled>true</enabled>
      <waitForPrevious>true</waitForPrevious>
    </connector>
  </destinationConnectors>
  <preprocessingScript>// Modify the message variable below to pre process data
return message;</preprocessingScript>
  <postprocessingScript>// This script executes once after a message has been processed
// Responses returned from here will be stored as &quot;Postprocessor&quot; in the response map
return;</postprocessingScript>
  <deployScript>// This script executes once when the channel is deployed
// You only have access to the globalMap and globalChannelMap here to persist data
return;</deployScript>
  <undeployScript>// This script executes once when the channel is undeployed
// You only have access to the globalMap and globalChannelMap here to persist data
return;</undeployScript>
  <properties version="4.4.0">
    <clearGlobalChannelMap>true</clearGlobalChannelMap>
    <messageStorageMode>DEVELOPMENT</messageStorageMode>
    <encryptData>false</encryptData>
    <encryptAttachments>false</encryptAttachments>
    <encryptCustomMetaData>false</encryptCustomMetaData>
    <removeContentOnCompletion>false</removeContentOnCompletion>
    <removeOnlyFilteredOnCompletion>false</removeOnlyFilteredOnCompletion>
    <removeAttachmentsOnCompletion>false</removeAttachmentsOnCompletion>
    <initialState>STARTED</initialState>
    <storeAttachments>true</storeAttachments>
    <metaDataColumns>
      <metaDataColumn>
        <name>SOURCE</name>
        <type>STRING</type>
        <mappingName>mirth_source</mappingName>
      </metaDataColumn>
      <metaDataColumn>
        <name>TYPE</name>
        <type>STRING</type>
        <mappingName>mirth_type</mappingName>
      </metaDataColumn>
    </metaDataColumns>
    <attachmentProperties version="4.4.0">
      <type>None</type>
      <properties/>
    </attachmentProperties>
    <resourceIds class="linked-hash-map">
      <entry>
        <string>Default Resource</string>
        <string>[Default Resource]</string>
      </entry>
    </resourceIds>
  </properties>
  <exportData>
    <metadata>
      <enabled>true</enabled>
      <lastModified>
        <time>1760888015556</time>
        <timezone>America/New_York</timezone>
      </lastModified>
      <pruningSettings>
        <archiveEnabled>true</archiveEnabled>
        <pruneErroredMessages>false</pruneErroredMessages>
      </pruningSettings>
      <userId>1</userId>
    </metadata>
    <codeTemplateLibraries>
      <codeTemplateLibrary version="4.4.0">
        <id>51277f88-12f3-49fd-ba9c-9e67f03d8419</id>
        <name>Env</name>
        <revision>3</revision>
        <lastModified>
          <time>1760639264315</time>
          <timezone>Etc/UTC</timezone>
        </lastModified>
        <description>
    </description>
        <includeNewChannels>true</includeNewChannels>
        <enabledChannelIds>
          <string>400018df-285e-478c-941f-c2edc31739b1</string>
          <string>aaf33967-fc20-40f2-ac82-8f717f7e8fd1</string>
          <string>c4eae20f-4d1b-4ede-b600-8da565e0aec4</string>
          <string>86b3733a-bbcb-4e66-8019-288a694c18ca</string>
          <string>619dbaf2-67ab-45a8-9f17-aa5379cf4bce</string>
          <string>fd3bb3e4-37e1-4560-b778-ac9ad8684f85</string>
          <string>4df074d0-8aff-49cf-89d4-846ab98c0a09</string>
          <string>9494e43b-15ca-4655-aa7e-ffbc323d3921</string>
          <string>f9467c56-c662-46db-9455-5b3c7d269be1</string>
          <string>52615302-657d-4f39-910b-8a6c4c6dccf9</string>
        </enabledChannelIds>
        <disabledChannelIds/>
        <codeTemplates>
          <codeTemplate version="4.4.0">
            <id>8e7f47e9-e5db-4c38-8cb4-d8a9e2c9f8e1</id>
            <name>getEnv</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547899670</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>CHANNEL_UNDEPLOY</contextType>
                <contextType>CHANNEL_DEPLOY</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>GLOBAL_PREPROCESSOR</contextType>
                <contextType>CHANNEL_BATCH</contextType>
                <contextType>CHANNEL_PREPROCESSOR</contextType>
                <contextType>GLOBAL_UNDEPLOY</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>GLOBAL_DEPLOY</contextType>
                <contextType>GLOBAL_POSTPROCESSOR</contextType>
                <contextType>CHANNEL_POSTPROCESSOR</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                <contextType>CHANNEL_ATTACHMENT</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function gets getEnvironmentConfig() JSON objects and set values needed for the channels and return a new JSON.
	@return {String} return file config JSON
*/
function getEnv() {
    let env = getEnvironmentConfig();
    let envJson = {};
    envJson.client = env.client;
    envJson.emr = env.emr;
    envJson.sendingApplication = env.sendingApplication;

    envJson.archiveDirectory = env.archiveDirectory;
    envJson.inboundDirectory = env.inboundDirectory;
    envJson.archiveDirectory = env.archiveDirectory;
    envJson.documentDirectory = env.documentDirectory;
    envJson.outboundDirectory = env.outboundDirectory;
    const dateString = DateUtil.getCurrentDate(&quot;YYYYMMddHHmmss&quot;);
    return envJson;
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>bd9cd38e-f6e8-41bb-b3ff-1b4453200d61</id>
            <name>getEnvironmentConfig</name>
            <revision>2</revision>
            <lastModified>
              <time>1760551770074</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>CHANNEL_UNDEPLOY</contextType>
                <contextType>CHANNEL_DEPLOY</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>GLOBAL_PREPROCESSOR</contextType>
                <contextType>CHANNEL_BATCH</contextType>
                <contextType>CHANNEL_PREPROCESSOR</contextType>
                <contextType>GLOBAL_UNDEPLOY</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>GLOBAL_DEPLOY</contextType>
                <contextType>GLOBAL_POSTPROCESSOR</contextType>
                <contextType>CHANNEL_POSTPROCESSOR</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                <contextType>CHANNEL_ATTACHMENT</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function parses the config map JSON file from settings.
	@return {String} return file config JSON
*/
function getEnvironmentConfig(name) {
	const configuration = configurationMap.get(name);
	if (this.isEmpty(configuration)) {
		throw &quot;An error has occured while reading the config file ERROR: &quot; + e;
     }
     return JSON.parse(configuration);
}</code>
            </properties>
          </codeTemplate>
        </codeTemplates>
      </codeTemplateLibrary>
      <codeTemplateLibrary version="4.4.0">
        <id>05a59498-fb4a-41b6-afe9-6905c699c3e6</id>
        <name>FileTools</name>
        <revision>4</revision>
        <lastModified>
          <time>1760639264311</time>
          <timezone>Etc/UTC</timezone>
        </lastModified>
        <description></description>
        <includeNewChannels>true</includeNewChannels>
        <enabledChannelIds>
          <string>400018df-285e-478c-941f-c2edc31739b1</string>
          <string>aaf33967-fc20-40f2-ac82-8f717f7e8fd1</string>
          <string>c4eae20f-4d1b-4ede-b600-8da565e0aec4</string>
          <string>86b3733a-bbcb-4e66-8019-288a694c18ca</string>
          <string>619dbaf2-67ab-45a8-9f17-aa5379cf4bce</string>
          <string>fd3bb3e4-37e1-4560-b778-ac9ad8684f85</string>
          <string>4df074d0-8aff-49cf-89d4-846ab98c0a09</string>
          <string>9494e43b-15ca-4655-aa7e-ffbc323d3921</string>
          <string>f9467c56-c662-46db-9455-5b3c7d269be1</string>
          <string>52615302-657d-4f39-910b-8a6c4c6dccf9</string>
        </enabledChannelIds>
        <disabledChannelIds/>
        <codeTemplates>
          <codeTemplate version="4.4.0">
            <id>2d7f78b5-de23-4a83-a202-4089f0629669</id>
            <name>createDirectory</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547901565</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function creates a directory.

	@param {String} directory - directory to be created
	@return {String} return function status
*/
function createDirectory(directory) {
    try {
        const create = Packages.java.lang.Runtime.getRuntime();
        create.exec(&apos;mkdir -p &apos; + directory);
        create.exec(&apos;chmod 0770 &apos; + directory);
    } catch (e) {
        return &quot;An error has occurred while creating directory &quot; + directory + &quot;; error:&quot; + e;
    }
    return &quot;Directory (&quot; + directory + &quot;) successfully created&quot;
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>4b18333f-000b-4fa2-b397-ada5c40740e6</id>
            <name>deleteFile</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547902098</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	this function delete a file.

	@param {String} FilePath - file path to be deleted
	@return {String} return function status
*/
function deleteFile(FilePath) {
    try {

        importPackage(Packages.ij.File);
        const fileToDelete = new java.io.File(FilePath)

        if (fileToDelete.exists) {
            fileToDelete.delete();
            return FilePath + &quot; has been deleted.&quot;;
        }

    } catch (e) {
        return e;
    }

}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>0a906fb3-e7b2-40ea-a820-3baa01555770</id>
            <name>fileEncodedBase64</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547901641</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function encoded file using base64.

	@param {String} file - file path to be encoded
	@return {String} return Encoded64 file 
*/
function fileEncodedBase64(file) {
        const fileRead = FileUtil.readBytes(file);
        return FileUtil.encode(fileRead);;

}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>7d59a265-4863-4ea1-bb37-96a76acf9a9d</id>
            <name>moveFile</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547900287</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>CHANNEL_UNDEPLOY</contextType>
                <contextType>CHANNEL_DEPLOY</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>GLOBAL_PREPROCESSOR</contextType>
                <contextType>CHANNEL_BATCH</contextType>
                <contextType>CHANNEL_PREPROCESSOR</contextType>
                <contextType>GLOBAL_UNDEPLOY</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>GLOBAL_DEPLOY</contextType>
                <contextType>GLOBAL_POSTPROCESSOR</contextType>
                <contextType>CHANNEL_POSTPROCESSOR</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                <contextType>CHANNEL_ATTACHMENT</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function moveFile(inboundDirectory , outboundDirectory, fileName) {
    try {

        importPackage(Packages.ij.File);
        const _file = new java.io.File(inboundDirectory + fileName)

        if (_file.exists) {
            _file.renameTo(new File(outboundDirectory + fileName));
            return fileName + &quot; has been moved.&quot;;
        }

    } catch (e) {
        return e;
    }
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>46a77c0b-c85c-4a16-be58-6be51caa80ba</id>
            <name>saveStringToFile</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547900756</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function saves string to file.

	@param {String} filename - name of the new file
	@param {String} directory - directory of the new file 
	@param {String} stringData - string to be comverted to file
	@param {String} append - option to apend or not
	@return {String} return new file 
*/
function saveStringToFile(filename, directory, stringData, append) {

    try {
        importPackage(Packages.ij.File);
        org.apache.commons.io.FileUtils.write(new java.io.File(directory + filename), stringData, append);
    } catch (e) {
        return &quot;An error has occured while saving file (&quot; + filename + &quot;); error:&quot; + e;
    }
}
</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>8902ec2e-38cc-4631-84fd-7f0c8e17d419</id>
            <name>ScriptSenderDateFormat</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547901162</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
This function formats date to standard ScriptSender date format (Aranya .. test test test1)

	@param {String} arg1 - date to be formated
	@return {String} return formated date
*/
function scriptSenderDateFormat(date) {
        let newdate;
        if (this.isNotEmpty(date)) {
            if (date.length === 8) {
                newdate = date + &apos;000000&apos;
            }
        }
        return newdate;

}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>7b085b69-6d65-4818-8f16-7c7882a6ce24</id>
            <name>ScriptSenderfileNameFormat</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547901434</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function create a Standard ScriptSender file name

	@return {String} return formated file name
*/
function scriptSenderfileNameFormat() {
        const dateString = DateUtil.getCurrentDate(&quot;YYYY/MM/dd/HH/mm/ss/SS&quot;);
        const yearString = DateUtil.getCurrentDate(&quot;YYYY&quot;);
        const monthString = DateUtil.getCurrentDate(&quot;MM&quot;);
        const dayString = DateUtil.getCurrentDate(&quot;dd&quot;);
        const hourString = DateUtil.getCurrentDate(&quot;HH&quot;);
        const minuteString = DateUtil.getCurrentDate(&quot;mm&quot;);
        const secondString = DateUtil.getCurrentDate(&quot;SS&quot;);

        const fileName = yearString + &quot;_&quot; + monthString + &quot;_&quot; + dayString + &quot;_&quot; + hourString + &quot;_&quot; + minuteString + &quot;_&quot; + secondString;
        return fileName;
}</code>
            </properties>
          </codeTemplate>
        </codeTemplates>
      </codeTemplateLibrary>
      <codeTemplateLibrary version="4.4.0">
        <id>ef65962a-07c9-4102-9bca-dccd343bceb1</id>
        <name>HL7Tools</name>
        <revision>11</revision>
        <lastModified>
          <time>1760706194145</time>
          <timezone>Etc/UTC</timezone>
        </lastModified>
        <description></description>
        <includeNewChannels>true</includeNewChannels>
        <enabledChannelIds>
          <string>aaf33967-fc20-40f2-ac82-8f717f7e8fd1</string>
          <string>9494e43b-15ca-4655-aa7e-ffbc323d3921</string>
        </enabledChannelIds>
        <disabledChannelIds/>
        <codeTemplates>
          <codeTemplate version="4.4.0">
            <id>06a16ade-c2fb-4168-b3c3-d75b3ef28c10</id>
            <name>deleteEmptySegments</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547900616</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function deletes empty segments from an HL7 message

	@param {String} data - HL7 message
	@return {String} return new HL7 message with non-empty segments
*/
function deleteEmptySegments(data) {
    for (let i = 0; i &lt; data.length; i++) {
        const seg = data[i];
        if (this.isNotEmpty(seg)) {
            let emptySegmentFound = false;
            for (let j = 0; j &lt; seg.length; j++) {
                const sec = seg[j];
                if (this.isNotEmpty(sec)) {
                    emptySegmentFound = true;
                    //break;
                }
            }
            ///const name = seg.localName().toString();
            if (emptySegmentFound === true) {
                delete(data.children()[seg.childIndex()])
            }
        }else{
        	return;
        }
    }
    return data;
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>4f18df72-6e90-427e-a19e-ca03d4dd6434</id>
            <name>formatDoctorFromObx5</name>
            <revision>1</revision>
            <lastModified>
              <time>1760649138972</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
// Build &quot;Hernandez, Maria J, MD (12345)&quot; from OBX.5 components
function formatDoctorFromObx5(obx) {
    var root = obx[&apos;OBX.5&apos;];
    if (!root) return null;

    // Some feeds put plain text in 5.1 (e.g., &quot;None recorded&quot;)
    var first = getComp(obx, &apos;OBX.5.1&apos;);
    if (/^none\s+recorded$/i.test(first)) return &apos;None recorded&apos;;

    var id     = first;                    // OBX.5.1 (ID)
    var family = getComp(obx, &apos;OBX.5.2&apos;);  // last
    var given  = getComp(obx, &apos;OBX.5.3&apos;);  // first
    var middle = getComp(obx, &apos;OBX.5.4&apos;);  // middle
    var suffix = getComp(obx, &apos;OBX.5.5&apos;);  // suffix
    var degree = getComp(obx, &apos;OBX.5.6&apos;);  // degree (MD/DO)
    // OBX.5.8 often holds assigning authority (&quot;NPI&quot;), not needed in pretty print

    // If only 5.1 is present and it&apos;s not &quot;None recorded&quot;, just return it
    var hasNameBits = family || given || middle || suffix || degree;
    if (!hasNameBits &amp;&amp; id &amp;&amp; !/^\d+$/.test(id)) {
        return id; // it&apos;s already a text name
    }

    var name = &apos;&apos;;
    if (family) name += family;
    if (given)  name += (name ? &apos;, &apos; : &apos;&apos;) + given;
    if (middle) name += &apos; &apos; + middle;
    if (suffix) name += &apos;, &apos; + suffix;
    if (degree) name += &apos;, &apos; + degree;
    if (id)     name += &apos; (&apos; + id + &apos;)&apos;;

    return name || null;
}
</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>316d0e68-b32b-4f52-a62a-84d0223ced73</id>
            <name>formatXCN</name>
            <revision>1</revision>
            <lastModified>
              <time>1760648039638</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
 * Parse an XCN like &quot;12345^Hernandez^Maria^J^^MD^^NPI&quot; into a neat string:
 * &quot;Hernandez, Maria J, MD (12345)&quot;. If it&apos;s &quot;None recorded&quot;, returns that.
 */
function formatXCN(xcn) {
    if (!xcn) return null;
    var s = String(xcn).trim();
    if (s === &apos;&apos; || /^none\s+recorded$/i.test(s)) return &apos;None recorded&apos;;

    var parts = s.split(&apos;^&apos;);
    var id       = parts[0] || &apos;&apos;;
    var family   = parts[1] || &apos;&apos;;
    var given    = parts[2] || &apos;&apos;;
    var middle   = parts[3] || &apos;&apos;;
    var suffix   = parts[4] || &apos;&apos;;
    var degree   = parts[5] || &apos;&apos;;

    var name = (family ? family : &apos;&apos;);
    if (given)  name += (name ? &apos;, &apos; : &apos;&apos;) + given;
    if (middle) name += &apos; &apos; + middle;
    if (suffix) name += &apos;, &apos; + suffix;
    if (degree) name += (degree ? &apos;, &apos; + degree : &apos;&apos;);

    if (id) name += &apos; (&apos; + id + &apos;)&apos;;
    return name || s; // fallback to raw if all else empty
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>521495cc-c9fd-49e4-8c2b-8f9ae48227ff</id>
            <name>formatXCNFromObx5</name>
            <revision>1</revision>
            <lastModified>
              <time>1760705480038</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function formatXCNFromObx5(obx) {
  // Some feeds put plain text in 5.1 (e.g., &quot;None recorded&quot;)
  var first = gx(obx, &apos;OBX.5.1&apos;);
  if (/^none\s+recorded$/i.test(first)) return &apos;None recorded&apos;;

  var id     = first;                 // OBX.5.1
  var family = gx(obx, &apos;OBX.5.2&apos;);    // last
  var given  = gx(obx, &apos;OBX.5.3&apos;);    // first
  var middle = gx(obx, &apos;OBX.5.4&apos;);    // middle
  var suffix = gx(obx, &apos;OBX.5.5&apos;);    // suffix
  var degree = gx(obx, &apos;OBX.5.6&apos;);    // MD/DO
  // OBX.5.8 often &quot;NPI&quot; (assigning authority) — not needed for display

  // If only 5.1 exists and looks like a name (not just digits), return it
  if (!(family || given || middle || suffix || degree) &amp;&amp; id &amp;&amp; !/^\d+$/.test(id)) return id;

  var name = &apos;&apos;;
  if (family) name += family;
  if (given)  name += (name ? &apos;, &apos; : &apos;&apos;) + given;
  if (middle) name += &apos; &apos; + middle;
  if (suffix) name += &apos;, &apos; + suffix;
  if (degree) name += &apos;, &apos; + degree;
  if (id)     name += &apos; (&apos; + id + &apos;)&apos;;

  return name || null;
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>cc5894c3-917e-446d-b536-d4b09b12daf8</id>
            <name>getComp</name>
            <revision>1</revision>
            <lastModified>
              <time>1760649138961</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>// Read a text value from a component safely (returns &quot;&quot; if missing)
function getComp(node, compPath) {
    try {
        var n = node;
        var parts = compPath.split(&apos;.&apos;);
        for (var i = 0; i &lt; parts.length; i++) {
            n = n[parts[i]];
            if (!n) return &apos;&apos;;
        }
        var s = String(n);
        return s != null ? s.trim() : &apos;&apos;;
    } catch (e) {
        return &apos;&apos;;
    }
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>bb293acb-311d-4985-a522-ed72da91f164</id>
            <name>getHL7Array</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547901466</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function comverts an HL7 segment to an array

	@param {String} data - data HL7 segment
	@param {Object} field - Field from HL7 segment
 	@return {String} return Array
*/
function getHL7Array(data, field) {
        let hl7Result = [];
        if (this.isNotEmpty(field)) {
            for (let i = 0; i &lt; data.length; i++) {
                hl7Result.push(data[i][field].toString());
            }

            if (hl7Result.length &gt; 1) {
                return hl7Result;
            } else {
                return data[field].toString();
            }
        }
        return data;
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>175545d6-9e52-4498-af74-9d764ea4628c</id>
            <name>getSubSegmentArray</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547901785</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function gets sub-Segment array of an HL7 segment

	@param {Object} seg - HL7 segment
	@return {Json} return Json array
*/
function getSubSegmentArray(seg) {
    let children = [];
    let childCount = seg.children().length;

    if (childCount &gt; 0 ) {

    		for (let i = 0; i &lt; childCount; i++) {
        		const child = seg.children()[i];
        		children.push(child.toString());
    		}
    } else {
    	   children = &quot;&quot;;
        for (let j = 0; j &lt; seg.children().length; j++) {
            const grandChild = seg.children()[j];
            children = grandChild.toString();
        }
    }
    return children;
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>ac69c1df-64d4-43a2-abc5-28e90464d94e</id>
            <name>gx</name>
            <revision>1</revision>
            <lastModified>
              <time>1760705480003</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function gx(root, path) {
  // Safe getter for HL7 XML: tries multiple path styles (CE.1 vs OBX.3.1)
  try {
    var node = root, parts = path.split(&apos;.&apos;);
    for (var i = 0; i &lt; parts.length; i++) {
      node = node[parts[i]];
      if (!node) return &apos;&apos;;
    }
    var s = String(node);
    return s != null ? s.trim() : &apos;&apos;;
  } catch (e) { return &apos;&apos;; }
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>49329932-85a4-49fd-a321-b1fefff31a58</id>
            <name>mapDischargeFromOBX</name>
            <revision>7</revision>
            <lastModified>
              <time>1760648769695</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
 * Loop through all OBX segments and map:
 *  - Note (LOINC 18842-5 Discharge summary -&gt; OBX-5)
 *  - AdmittingDoctor (ADM_DOC -&gt; OBX-5 XCN)
 *  - ConsultingDoctor (CONS_DOC -&gt; OBX-5 XCN or &quot;None recorded&quot;)
 *  - DischargeDoctor (DIS_DOC -&gt; OBX-5 XCN)
 */
function mapDischargeFromOBX(notes) {
    // clear / initialize (optional — comment out if you prefer to keep prior values)
    channelMap.put(&apos;Note&apos;, null);
    channelMap.put(&apos;AdmittingDoctor&apos;, null);
    channelMap.put(&apos;ConsultingDoctor&apos;, null);
    channelMap.put(&apos;DischargeDoctor&apos;, null);

    // msg.OBX is a repeating segment list in Mirth’s HL7 XML
    var count = (notes.OBX ? notes.OBX.length() : 0);

    for (var i = 0; i &lt; count; i++) {
        var obx = notes.OBX[i];

        // OBX-3 (CE) – observation identifier
        var idCE1 = (obx[&apos;OBX.3&apos;][&apos;OBX.3.1&apos;] ? String(obx[&apos;OBX.3&apos;][&apos;OBX.3.1&apos;]) : &apos;&apos;).trim(); // code
        var idCE2 = (obx[&apos;OBX.3&apos;][&apos;OBX.3.2&apos;] ? String(obx[&apos;OBX.3&apos;][&apos;OBX.3.2&apos;]) : &apos;&apos;).trim(); // text
        // OBX-5 – observation value (for TX/NM/etc. we read as string)
        var val   = (obx[&apos;OBX.5&apos;] ? String(obx[&apos;OBX.5&apos;]) : &apos;&apos;).trim();
        
        if (!idCE1 &amp;&amp; !idCE2) continue;

        // Discharge Note (LOINC 18842-5 or text contains &quot;Discharge summary&quot;)
        if (idCE1 === &apos;18842-5&apos; || /discharge\s*summary/i.test(idCE2)) {
            // If multiple OBX for notes, join with a blank line
            var currentNote = channelMap.get(&apos;Note&apos;);
            if (currentNote &amp;&amp; String(currentNote).trim() !== &apos;&apos;) {
                channelMap.put(&apos;Note&apos;, String(currentNote) + &apos;\n\n&apos; + val);
            } else {
                channelMap.put(&apos;Note&apos;, val);
            }
            continue;
        }

        // Admitting doctor
        if (idCE1 === &apos;ADM_DOC&apos; || /admitting\s*doctor/i.test(idCE2)) {
            channelMap.put(&apos;AdmittingDoctor&apos;, formatXCN(val));
            continue;
        }

        // Consulting doctor
        if (idCE1 === &apos;CONS_DOC&apos; || /consulting\s*doctor/i.test(idCE2)) {
            channelMap.put(&apos;ConsultingDoctor&apos;, formatXCN(val));
            continue;
        }

        // Discharge doctor
        if (idCE1 === &apos;DIS_DOC&apos; || /discharge\s*doctor/i.test(idCE2)) {
            channelMap.put(&apos;DischargeDoctor&apos;, formatXCN(val));
            continue;
        }
    }

    // Optional: if consulting is still blank and OBX said &quot;None recorded&quot;, set explicitly
    if (!channelMap.get(&apos;ConsultingDoctor&apos;)) {
        // leave as null; consumer can treat null as &quot;unknown&quot;
    }
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>1045604d-06d7-4068-adf4-c34f27969ba5</id>
            <name>mapDischargeFromOBX_clean</name>
            <revision>1</revision>
            <lastModified>
              <time>1760705480050</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function mapDischargeFromOBX_clean(root) {
  // init/clear
  channelMap.put(&apos;Note&apos;, null);
  channelMap.put(&apos;AdmittingDoctor&apos;, null);
  channelMap.put(&apos;ConsultingDoctor&apos;, null);
  channelMap.put(&apos;DischargeDoctor&apos;, null);

  var list = root.OBX ? root.OBX : msg.OBX; // allow passing msg or a subnode
  var count = list ? list.length() : 0;

  for (var i = 0; i &lt; count; i++) {
    var obx = list[i];
    var code = obxIdCode(obx);
    var text = obxIdText(obx);

    // NOTE (18842-5 Discharge summary). For TX, value is in OBX.5.1
    if (code === &apos;18842-5&apos; || /discharge\s*summary/i.test(text)) {
      var noteTxt = gx(obx, &apos;OBX.5.TX.1&apos;) || gx(obx, &apos;OBX.5.1&apos;);
      if (noteTxt) {
        var cur = String(channelMap.get(&apos;Note&apos;) || &apos;&apos;);
        channelMap.put(&apos;Note&apos;, cur ? (cur + &apos;\n\n&apos; + noteTxt) : noteTxt);
      }
      continue;
    }

    // Admitting doctor
    if (code === &apos;ADM_DOC&apos; || /admitting\s*doctor/i.test(text)) {
      channelMap.put(&apos;AdmittingDoctor&apos;, formatXCNFromObx5(obx));
      continue;
    }

    // Consulting doctor
    if (code === &apos;CONS_DOC&apos; || /consulting\s*doctor/i.test(text)) {
      channelMap.put(&apos;ConsultingDoctor&apos;, formatXCNFromObx5(obx));
      continue;
    }

    // Discharge doctor
    if (code === &apos;DIS_DOC&apos; || /discharge\s*doctor/i.test(text)) {
      channelMap.put(&apos;DischargeDoctor&apos;, formatXCNFromObx5(obx));
      continue;
    }
  }
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>5b2477a5-9f86-4be4-9d76-fbf7362a1855</id>
            <name>mapDischargeFromOBX_components</name>
            <revision>4</revision>
            <lastModified>
              <time>1760704989298</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
// Extract discharge note and doctors into channelMap
function mapDischargeFromOBX_components(notes) {
    channelMap.put(&apos;Note&apos;, null);
    channelMap.put(&apos;AdmittingDoctor&apos;, null);
    channelMap.put(&apos;ConsultingDoctor&apos;, null);
    channelMap.put(&apos;DischargeDoctor&apos;, null);

    var total = (notes.OBX ? notes.OBX.length() : 0);
    for (var i = 0; i &lt; total; i++) {
        var obx = notes.OBX[i];
        var id1 = getComp(obx, &apos;OBX.3.1&apos;); // code [&apos;OBX.3&apos;][&apos;OBX.3.1&apos;]
        var id2 = getComp(obx, &apos;OBX.3.2&apos;); // text
//        var id1 = (obx[&apos;OBX.3&apos;][&apos;OBX.3.1&apos;] ? String(obx[&apos;OBX.3&apos;][&apos;OBX.3.1&apos;]) : &apos;&apos;).trim(); // code
//        var id2 = (obx[&apos;OBX.3&apos;][&apos;OBX.3.2&apos;] ? String(obx[&apos;OBX.3&apos;][&apos;OBX.3.2&apos;]) : &apos;&apos;).trim(); // text

        // NOTE (LOINC 18842-5 or text &quot;Discharge summary&quot;) -&gt; OBX.5.1
        if (id1 === &apos;18842-5&apos; || /discharge\s*summary/i.test(id2)) {
            var t = getComp(obx, &apos;OBX.5.1&apos;);
            if (t) {
                var cur = String(channelMap.get(&apos;Note&apos;) || &apos;&apos;);
                channelMap.put(&apos;Note&apos;, cur ? (cur + &apos;\n\n&apos; + t) : t);
            }
            continue;
        }

        // Admitting doctor (ADM_DOC)
        if (id1 === &apos;ADM_DOC&apos; || /admitting\s*doctor/i.test(id2)) {
            channelMap.put(&apos;AdmittingDoctor&apos;, formatDoctorFromObx5(obx));
            continue;
        }

        // Consulting doctor (CONS_DOC)
        if (id1 === &apos;CONS_DOC&apos; || /consulting\s*doctor/i.test(id2)) {
            channelMap.put(&apos;ConsultingDoctor&apos;, formatDoctorFromObx5(obx));
            continue;
        }

        // Discharge doctor (DIS_DOC)
        if (id1 === &apos;DIS_DOC&apos; || /discharge\s*doctor/i.test(id2)) {
            channelMap.put(&apos;DischargeDoctor&apos;, formatDoctorFromObx5(obx));
            continue;
        }
    }
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>228e2483-23b4-411a-ba0f-dd59b4df9038</id>
            <name>mapDischargeOBX2</name>
            <revision>3</revision>
            <lastModified>
              <time>1760706531938</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
// Safe getter for HL7 XML like OBX.3.1 or OBX.5.2
function gx(node, path) {
    try {
        var n = node;
        var parts = path.split(&apos;.&apos;);
        for (var i = 0; i &lt; parts.length; i++) {
            n = n[parts[i]];
            if (!n) return &apos;&apos;;
        }
        var s = String(n);
        return s != null ? s.trim() : &apos;&apos;;
    } catch (e) { return &apos;&apos;; }
}

// Pretty print doctor from OBX.5 components
function formatDoctor(obx) {
    var v1 = gx(obx, &apos;OBX.5.1&apos;);
    if (/^none\s+recorded$/i.test(v1)) return &apos;None recorded&apos;;

    var id     = v1;                    // id (or sometimes free text)
    var family = gx(obx, &apos;OBX.5.2&apos;);    // last
    var given  = gx(obx, &apos;OBX.5.3&apos;);    // first
    var middle = gx(obx, &apos;OBX.5.4&apos;);    // middle
    var suffix = gx(obx, &apos;OBX.5.5&apos;);    // suffix
    var degree = gx(obx, &apos;OBX.5.6&apos;);    // MD/DO

    // If only OBX.5.1 exists and it&apos;s not just digits, treat it as a preformatted name
    if (!(family || given || middle || suffix || degree) &amp;&amp; id &amp;&amp; !/^\d+$/.test(id)) {
        return id;
    }

    var name = &apos;&apos;;
    if (family) name += family;
    if (given)  name += (name ? &apos;, &apos; : &apos;&apos;) + given;
    if (middle) name += &apos; &apos; + middle;
    if (suffix) name += &apos;, &apos; + suffix;
    if (degree) name += &apos;, &apos; + degree;
    if (id)     name += &apos; (&apos; + id + &apos;)&apos;;

    return name || null;
}

function mapDischargeOBX2(root) {
    // init/clear
    channelMap.put(&apos;Note&apos;, null);
    channelMap.put(&apos;AdmittingDoctor&apos;, null);
    channelMap.put(&apos;ConsultingDoctor&apos;, null);
    channelMap.put(&apos;DischargeDoctor&apos;, null);

    var list = (root &amp;&amp; root.OBX) ? root.OBX : (msg.OBX || null);
    var count = list ? list.length() : 0;

    for (var i = 0; i &lt; count; i++) {
        var obx = list[i];
        var code = gx(obx, &apos;OBX.3.1&apos;); // e.g., 18842-5, ADM_DOC, CONS_DOC, DIS_DOC
        var text = gx(obx, &apos;OBX.3.2&apos;); // description

        // NOTE: Discharge summary (TX) lives in OBX.5.1
        if (code === &apos;18842-5&apos; || /discharge\s*summary/i.test(text)) {
            var t = gx(obx, &apos;OBX.5.1&apos;);
            if (t) {
                var cur = String(channelMap.get(&apos;Note&apos;) || &apos;&apos;);
                channelMap.put(&apos;Note&apos;, cur ? (cur + &apos;\n\n&apos; + t) : t);
            }
            continue;
        }

        if (code === &apos;ADM_DOC&apos; || /admitting\s*doctor/i.test(text)) {
            channelMap.put(&apos;AdmittingDoctor&apos;, formatDoctor(obx));
            continue;
        }
        if (code === &apos;CONS_DOC&apos; || /consulting\s*doctor/i.test(text)) {
            channelMap.put(&apos;ConsultingDoctor&apos;, formatDoctor(obx));
            continue;
        }
        if (code === &apos;DIS_DOC&apos; || /discharge\s*doctor/i.test(text)) {
            channelMap.put(&apos;DischargeDoctor&apos;, formatDoctor(obx));
            continue;
        }
    }
}
</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>031c5d4a-5c56-4ba8-bce1-62ea7d68a8fd</id>
            <name>obxIdCode</name>
            <revision>1</revision>
            <lastModified>
              <time>1760705480013</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function obxIdCode(obx) {
  return gx(obx, &apos;OBX.3.CE.1&apos;) || gx(obx, &apos;OBX.3.1&apos;);
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>73bd4c7f-c98c-4293-80d0-a0a26cc8c945</id>
            <name>obxIdText</name>
            <revision>1</revision>
            <lastModified>
              <time>1760705480025</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function obxIdText(obx) {
  return gx(obx, &apos;OBX.3.CE.2&apos;) || gx(obx, &apos;OBX.3.2&apos;);
}
</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>852612ab-a32d-4bec-913f-20f4476764b0</id>
            <name>stripEmptyNodes</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547900573</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function stripEmptyNodes from xml

	@param {String} node - xml node
	@param {String} stripWhitespaceNodes - White space
	@param {String} onlyDeleteTrailing - only Delete Trailing
	@return {String} return new xml
*/
function stripEmptyNodes(node, stripWhitespaceNodes, onlyDeleteTrailing) {
        let nonEmptyFound = false;
        for (let childIndex = node.children().length() - 1; childIndex &gt;= 0; childIndex--) {
            const child = node.children()[childIndex];
            stripEmptyNodes(child, stripWhitespaceNodes, onlyDeleteTrailing);
            if (stripWhitespaceNodes &amp;&amp; !child.toString().trim() || !stripWhitespaceNodes &amp;&amp; !child.toString())
                if (!nonEmptyFound || !onlyDeleteTrailing)
                    delete node.children()[childIndex];
                else
                    node.children()[childIndex] = new XML(&apos;&lt;&apos; + child.name().toString() + &apos;/&gt;&apos;);
            else
                nonEmptyFound = true;
        }

}</code>
            </properties>
          </codeTemplate>
        </codeTemplates>
      </codeTemplateLibrary>
      <codeTemplateLibrary version="4.4.0">
        <id>b4bd70c8-5783-43fc-9ef5-1f40a861e91b</id>
        <name>JsonParsers</name>
        <revision>5</revision>
        <lastModified>
          <time>1760706797206</time>
          <timezone>Etc/UTC</timezone>
        </lastModified>
        <description></description>
        <includeNewChannels>true</includeNewChannels>
        <enabledChannelIds>
          <string>aaf33967-fc20-40f2-ac82-8f717f7e8fd1</string>
          <string>9494e43b-15ca-4655-aa7e-ffbc323d3921</string>
        </enabledChannelIds>
        <disabledChannelIds/>
        <codeTemplates>
          <codeTemplate version="4.4.0">
            <id>4aba8233-6ddf-423b-8cdf-994b6eea8a1e</id>
            <name>parseExams</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547900127</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function parses a HL7 segment to Json

	@param {String} procedure_code - procedure_code from HL7 segment
	@param {String} RIS_ID - RIS_ID from HL7 segment
	@param {String} EMR_ID - EMR_ID from HL7 segment
	@param {String} PACS_accession_number - PACS_accession_number from HL7 segment
	@param {String} priority - priority from HL7 segment
	
	@param {String} modality - modality from HL7 segment
	@param {String} DateOfRequest - DateOfRequest from HL7 segment
	@param {String} DateOfObservation - DateOfObservation from HL7 segment
	@param {String} DateOfEncounter - DateOfEncounter from HL7 segment
	@param {String} study - study from HL7 segment
	
	@param {String} reasonForExam - reasonForExam from HL7 segment
	@param {String} approvingProvider - approvingProvider from HL7 segment
	@param {String} comment - comment from HL7 segment
	@param {Array} MultiDiagnosisList - MultiDiagnosisList is array list from HL7 segment
	@param {String} status - status from HL7 segment
	@return {String} return Json object
*/
function parseExams(procedure_code, RIS_ID, EMR_ID, PACS_accession_number, priority, modality, dateOfRequest, dateOfObservation, dateOfEncounter, study, reasonForExam, approvingProvider, comment, multiDiagnosisList) {
        let prior = &quot;&quot;;
        if (this.isNotEmpty(priority)) {
            prior = priority;
        }
        if(this.isNotEmpty(multiDiagnosisList)){
        	 return {
        		&quot;procedure_code&quot;:procedure_code,
        		&quot;EMR_ID&quot;:EMR_ID,
        		&quot;RIS_ID&quot;:RIS_ID,
        		&quot;PACS_accession_number&quot;:PACS_accession_number,
        		&quot;priority&quot;:prior,
        		&quot;modality&quot;:modality,
        		&quot;DateOfEncounter&quot;:dateOfEncounter,
        		&quot;DateOfObservation&quot;:dateOfObservation,
        		&quot;DateOfRequest&quot;:dateOfRequest,
        		&quot;study&quot;:study,
        		&quot;reasonForExam&quot;:reasonForExam,
        		&quot;approvingProvider&quot;:approvingProvider,
        		&quot;comment&quot;:comment,
        		&quot;MultiDiagnosisList&quot;:multiDiagnosisList
        };
        	 
        }  
        	return {
        		&quot;procedure_code&quot;:procedure_code,
        		&quot;EMR_ID&quot;:EMR_ID,
        		&quot;RIS_ID&quot;:RIS_ID,
        		&quot;PACS_accession_number&quot;:PACS_accession_number,
        		&quot;priority&quot;:priority,
        		&quot;modality&quot;:modality,
        		&quot;DateOfEncounter&quot;:dateOfEncounter,
        		&quot;DateOfObservation&quot;:dateOfObservation,
        		&quot;DateOfRequest&quot;:dateOfRequest,
        		&quot;study&quot;:study,
        		&quot;reasonForExam&quot;:reasonForExam,
        		&quot;approvingProvider&quot;:approvingProvider,
        		&quot;comment&quot;:comment    
        };
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>37040130-244e-40b6-987f-f110928fb73e</id>
            <name>parseGuarantor</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547902144</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function parses a HL7 segment to Json

	@param {String} firstname - firstname from HL7 segment
	@param {String} lastname - lastname from HL7 segment
	@param {String} middlename - middlename from HL7 segment
	@param {String} relationship - relationship from HL7 segment
	@param {String} title - title from HL7 segment
	@param {String} DOB - DOB from HL7 segment
	@param {String} sex - sex from HL7 segment
	@param {String} address - address from HL7 segment
	@param {Object} contacts - contacts from HL7 segment
	@return {String} return Json object
*/

function parseGuarantor(firstName, lastName, middleName, relationShip, title, DOB, sex, address, contacts) {
        return {
        &quot;name&quot;:getFullName(firstName, lastName, middleName),
        &quot;relationship&quot;:relationShip,
        &quot;firstname&quot;:firstName,
        &quot;middlename&quot;:middleName,
        &quot;lastname&quot;:lastName,
        &quot;title&quot;:title,
        &quot;DOB&quot;:DOB,
        &quot;sex&quot;:sex,
        &quot;address&quot;:address,
        &quot;contacts&quot;:contacts
        };

}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>2e6e8094-05ad-4aaf-898e-22b8507df529</id>
            <name>parseInsurance</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547901240</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function parses a HL7 segment to Json

	@param {String} name - name from HL7 segment
	@param {String} type - type from HL7 segment
	@param {String} insuranceaddress - insuranceaddress from HL7 segment
	@param {String} companyNumber - companyNumber from HL7 segment
	@param {String} planName - planName from HL7 segment
	@param {String} memberNumber - memberNumber from HL7 segment
	@param {String} authorization - authorization from HL7 segment
	@param {String} insuredinfo - insuredinfo from HL7 segment
	@param {String} groupNumber - groupNumber from HL7 segment
	@param {String} address - address from HL7 segment
	@return {String} return Json object
*/
function parseInsurance(name, type, insuranceaddress, companyNumber, planName, memberNumber, authorization, insuredinfo, groupNumber, address) {

        return {
        &quot;name&quot;:name,
        &quot;type&quot;:type,
        &quot;insurance-address&quot;:address,
        &quot;insured&quot;:insuredinfo,
        &quot;memberNumber&quot;:memberNumber,
        &quot;authorization&quot;:authorization,
        &quot;groupNumber&quot;:groupNumber,
        &quot;planName&quot;:planName,
        &quot;companyNumber&quot;:companyNumber
        };
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>16b2cdfb-dd8d-4274-8aea-a021480c035d</id>
            <name>parseObservations</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547901016</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function parses a HL7 segment to Json

	@param {String} valueType - valueType from HL7 segment
	@param {String} obsIdentifier - obsIdentifier from HL7 segment
	@param {String} subID - subID from HL7 segment
	@param {String} value - value from HL7 segment
	@param {String} resultStatus - resultStatus from HL7 segment
	@param {String} name - name from HL7 segment
	@param {String} firstname - firstname from HL7 segment
	@param {String} middlename - middlename from HL7 segment
	@param {String} lastname - lastname from HL7 segment
	@param {String} title - title from HL7 segment
	@param {String} code - code from HL7 segment
	@return {String} return Json object
*/
function parseObservations(valueType, obsIdentifier, subID, value, resultStatus, name, firstname, middlename, lastname, title, code) {

        let observer = {
            &quot;name&quot;: &quot;&quot;,
            &quot;firstname&quot;: &quot;&quot;,
            &quot;middlename&quot;: &quot;&quot;,
            &quot;lastname&quot;: &quot;&quot;,
            &quot;title&quot;: &quot;&quot;,
            &quot;code&quot;: &quot;&quot;
        };
        return {
        &quot;valueType&quot;:valueType,
        &quot;obsIdentifier&quot;:obsIdentifier,
        &quot;subID&quot;:subID,
        &quot;value&quot;:value,
        &quot;resultStatus&quot;:resultStatus,
        &quot;observer&quot;:observer
        };
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>c0210354-16bd-4919-8d16-5450d181177e</id>
            <name>parseOrder</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547900467</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function parses a HL7 segment to Json

	@param {String} accession - accession from HL7 segment
	@param {String} placerordernumber - placerordernumber from HL7 segment
	@param {String} sendingApplication - sendingApplication from HL7 segment
	@param {String} servicingFacility - servicingFacility from HL7 segment
	@param {String} DateOfService - DateOfService from HL7 segment
	@param {String} pid - pid from HL7 segment
	@return {String} return Json object
*/
function parseOrder(accession, placerOrdernumber, sendingApplication, servicingFacility, dateOfService, pid) {

        return {
        &quot;accession&quot;:accession,
        &quot;placer_order_number&quot;:placerOrdernumber,
        &quot;sendingApplication&quot;:sendingApplication,
        &quot;servicingFacility&quot;:servicingFacility,
        &quot;DateOfService&quot;:dateOfService,
        &quot;PID&quot;:pid
        };
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>db09b6b7-b3cc-4b90-b48f-e91836eadc8d</id>
            <name>parseORUtoJSON</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547901679</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function parses a HL7 segment to Json

	@param {object} referringDr - referringDr from HL7 segment
	@param {object} report - report from HL7 segment
	@param {object} patient - patient from HL7 segment
	@param {object} readingRadiologist - readingRadiologist from HL7 segment
	@param {object} exam - exam from HL7 segment
	@param {object} observations - observations from HL7 segment
	@param {object} observations - observations from HL7 segment
	@param {object} meta - meta from HL7 segment
	@return {object} return Json object
*/
function parseORUtoJSON(referringDr, report, patient, readingRadiologist, exam, observations, meta) {
    let getReferringDr;
    if (this.isNotEmpty(referringDr) &amp;&amp; this.isNotEmpty(referringDr.name)) {
        getReferringDr = referringDr;
    }
    return {
    &quot;referringDr&quot;:getReferringDr,
    &quot;report&quot;:report,
    &quot;patient&quot;:patient,
    &quot;readingRadiologist&quot;:readingRadiologist,
    &quot;exams&quot;:exam,
    &quot;observations&quot;:observations,
    &quot;meta&quot;:meta};

}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>ac711e1e-307a-475f-9cb1-29f1800e5bc0</id>
            <name>parsePatient</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547900231</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function parses a HL7 segment to Json

	@param {String} name - name from HL7 segment
	@param {String} firstname - firstname from HL7 segment
	@param {String} lastname - lastname from HL7 segment
	@param {String} middlename - middlename from HL7 segment
	@param {String} title - title from HL7 segment	
	@param {String} RIS_PID - RIS_PID from HL7 segment
	@param {String} EMR_PID - EMR_PID from HL7 segment
	@param {String} visitNumber - visitNumber from HL7 segment
	@param {String} pclass - pclass from HL7 segment	
	@param {String} dob - dob from HL7 segment	
	@param {String} DOS - DOS from HL7 segment
	@param {String} sex - sex from HL7 segment	
	@param {String} address1 - address1 from HL7 segment
	@param {String} address2 - address2 is array list from HL7 segment
	@param {String} city - city from HL7 segment
	@param {String} state - state from HL7 segment
	@param {String} country - country is array list from HL7 segment
	@param {String} zip - zip from HL7 segment
	@param {Array} cont - cont from HL7 segment
	@param {String} language - language is array list from HL7 segment
	@param {String} race - race from HL7 segment
	@param {String} age - age from HL7 segment
	@param {String} ssn - ssn from HL7 segment
	@param {String} deathIndicator - deathIndicator from HL7 segment
	@param {String} dateOfDeath - dateOfDeath from HL7 segment
	@return {String} return Json object
*/

function parsePatient(name, firstname, lastname, middlename, title, RIS_PID, EMR_PID, visitNumber, pclass, dob, DOS, sex, address1, address2, city, state, country, zip, cont, language, race, age, ssn, deathIndicator, dateOfDeath) {
        let contact = [];
        contact = cont;
        return {
        &quot;name&quot;: getFullName(firstName, lastName, middleName),
        &quot;firstname&quot;:firstname,
        &quot;middlename&quot;:middlename,
        &quot;lastname&quot;:lastname,
        &quot;title&quot;:title,
        &quot;RIS_PID&quot;:RIS_PID,
        &quot;EMR_PID&quot;:EMR_PID,
        &quot;visitNumber&quot;:visitNumber,
        &quot;class&quot;:pclass,
        &quot;DOB&quot;:dob,
        &quot;DOS&quot;:DOS,
        &quot;sex&quot;:sex,
        &quot;address1&quot;:address1,
        &quot;address2&quot;:address2,
        &quot;city&quot;:city,
        &quot;state&quot;:state,
        &quot;country&quot;:country,
        &quot;zip&quot;:zip,
        &quot;contacts&quot;:contact,
        &quot;language&quot;:&quot;English&quot;,
        &quot;race&quot;:race,
        &quot;age&quot;:getPersonAge(dob, false, false),
        &quot;SSN&quot;:ssn,
        &quot;deathIndicator&quot;:deathIndicator,
        &quot;dateOfDeath&quot;:dateOfDeath
        };

}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>d9d09c49-84a8-41f8-83da-fe2c046b985f</id>
            <name>parsePatientORU</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547900422</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function parses a HL7 segment to Json

	@param {String} name - name from HL7 segment
	@param {String} firstname - firstname from HL7 segment
	@param {String} lastname - lastname from HL7 segment
	@param {String} middlename - middlename from HL7 segment
	@param {String} title - title from HL7 segment	
	@param {String} RIS_PID - RIS_PID from HL7 segment
	@param {String} EMR_PID - EMR_PID from HL7 segment
	@param {String} visitNumber - visitNumber from HL7 segment
	@param {String} pclass - pclass from HL7 segment	
	@param {String} dob - dob from HL7 segment	
	@param {String} DOS - DOS from HL7 segment
	@param {String} sex - sex from HL7 segment	
	@param {String} address1 - address1 from HL7 segment
	@param {String} address2 - address2 is array list from HL7 segment
	@param {String} city - city from HL7 segment
	@param {String} state - state from HL7 segment
	@param {String} country - country is array list from HL7 segment
	@param {String} zip - zip from HL7 segment
	@param {String} cont - cont from HL7 segment
	@param {String} language - language is array list from HL7 segment
	@param {String} race - race from HL7 segment
	@param {String} age - age from HL7 segment
	@param {String} ssn - ssn from HL7 segment
	@param {String} deathIndicator - deathIndicator from HL7 segment
	@param {String} dateOfDeath - dateOfDeath from HL7 segment
	@return {String} return Json object
*/

function parsePatientORU(name, firstname, lastname, middlename, title, RIS_PID, EMR_PID, visitNumber, pclass, dob, DOS, sex, address1, address2, city, state, country, zip, cont, language, race, age, ssn, deathIndicator, dateOfDeath) {

        let contact = [];
        if (this.isNotEmpty(cont)) {
            contact = cont;
        }
        let dob1 = &quot;&quot;;
        if (dob.length === 8) {
            dob1 = dob + &quot;000000&quot;;
        } else {
            dob1 = dob;
        }
        return {
        &quot;name&quot;:name,
        &quot;firstname&quot;:firstname,
        &quot;middlename&quot;:middlename,
        &quot;lastname&quot;:lastname,
        &quot;title&quot;:title,
        &quot;RIS_PID&quot;:RIS_PID,
        &quot;EMR_PID&quot;:EMR_PID,
        &quot;visitNumber&quot;:visitNumber,
        &quot;class&quot;:pclass,
        &quot;DOB&quot;:dob,
        &quot;DOS&quot;:DOS,
        &quot;sex&quot;:sex,
        &quot;address1&quot;:address1,
        &quot;address2&quot;:address2,
        &quot;city&quot;:city,
        &quot;state&quot;:state,
        &quot;country&quot;:country,
        &quot;zip&quot;:zip,
        &quot;contacts&quot;:contact,
        &quot;language&quot;:&quot;English&quot;,
        &quot;race&quot;:race,
        &quot;age&quot;:&quot;&quot; + getPersonAge(formatDate(dob), true, true) + &quot;&quot;,
        &quot;SSN&quot;:ssn,
        &quot;deathIndicator&quot;:deathIndicator,
        &quot;dateOfDeath&quot;:dateOfDeath
        };


}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>ef831296-97cb-4f41-a2b3-c2bc1ea7c042</id>
            <name>parseReadingRadiologist</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547901351</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function parses a HL7 segment to Json

	@param {String} name - name from HL7 segment
	@param {String} firstname - firstname from HL7 segment
	@param {String} middlename - middlename from HL7 segment
	@param {String} lastname - lastname from HL7 segment
	@param {String} title - title from HL7 segment
	@param {String} code - code from HL7 segment
	@param {String} sendingFacility - sendingFacility from HL7 segment
	@return {String} return Json object
*/

function parseReadingRadiologist(name, firstname, middlename, lastname, title, code, sendingFacility) {

        return {
        &quot;name&quot;:name,
        &quot;firstname&quot;:firstname,
        &quot;middlename&quot;:middlename,
        &quot;lastname&quot;:lastname,
        &quot;title&quot;:title,
        &quot;code&quot;:code,
        &quot;sendingFacility&quot;:sendingFacility
        };
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>0b42d6b9-b979-4fd9-9892-5817e34e331e</id>
            <name>parseReferringDoctor</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547901997</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function parses a HL7 segment to Json

	@param {String} name - name from HL7 segment
	@param {String} firstname - firstname from HL7 segment
	@param {String} lastname - lastname from HL7 segment
	@param {String} middlename - middlename from HL7 segment
	@param {String} title - title from HL7 segment
	@param {String} code - code from HL7 segment
	@param {String} address - address from HL7 segment
	@param {String} contact - contact from HL7 segment
	@param {String} sendingFacility - sendingFacility from HL7 segment
	@return {String} return Json object
*/
function parseReferringDoctor(name, firstname, lastname, middlename, title, code, address, contact, sendingFacility) {

        return {
        &quot;name&quot;:name,
        &quot;firstname&quot;:firstname,
        &quot;middlename&quot;:middlename,
        &quot;lastname&quot;:lastname,
        &quot;title&quot;:title,
        &quot;code&quot;:code,
        &quot;address1&quot;:address.address1,
        &quot;address2&quot;:address.address2,
        &quot;city&quot;:address.city,
        &quot;state&quot;:address.state,
        &quot;country&quot;:address.country,
        &quot;zip&quot;:address.zip,
        &quot;contacts&quot;:contact,
        &quot;sendingFacility&quot;:sendingFacility
        };
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>d2b9111b-a138-414c-ac7e-945c704eb961</id>
            <name>parseReport</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547899729</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function parses a HL7 segment to Json

	@param {String} sendingApplication - sendingApplication from HL7 segment
	@param {String} sendingFacility - sendingFacility from HL7 segment
	@param {String} servicingFacility - servicingFacility from HL7 segment
	@param {String} assignedPatientFacility - assignedPatientFacility from HL7 segment
	@param {String} entererFacility - entererFacility from HL7 segment	
	@param {String} entererOrganization - entererOrganization from HL7 segment
	@param {String} receivingApplication - receivingApplication from HL7 segment
	@param {String} DateTimeOfMessage - DateTimeOfMessage from HL7 segment
	@param {String} DateOfReportOrStatusChange - DateOfReportOrStatusChange from HL7 segment
	@param {String} resultStatus - resultStatus from HL7 segment
	@return {String} return Json object
*/
function parseReport(sendingApplication, sendingFacility, servicingFacility, assignedPatientFacility, entererFacility, entererOrganization, receivingApplication, dateTimeOfMessage, dateOfReportOrStatusChange, resultStatus) {

        return {
        &quot;sendingApplication&quot;:sendingApplication,
        &quot;sendingFacility&quot;:sendingFacility,
        &quot;servicingFacility&quot;:servicingFacility,
        &quot;assignedPatientFacility&quot;:assignedPatientFacility,
        &quot;entererFacility&quot;:entererFacility,
        &quot;entererOrganization&quot;:entererOrganization,
        &quot;receivingApplication&quot;:receivingApplication,
        &quot;DateTimeOfMessage&quot;:dateTimeOfMessage,
        &quot;DateOfReportOrStatusChange&quot;:dateOfReportOrStatusChange,
        &quot;resultStatus&quot;:resultStatus
        };

}</code>
            </properties>
          </codeTemplate>
        </codeTemplates>
      </codeTemplateLibrary>
      <codeTemplateLibrary version="4.4.0">
        <id>79b538f1-496d-4fd7-89d2-c3f5ac9deeb7</id>
        <name>JsonTemplates</name>
        <revision>4</revision>
        <lastModified>
          <time>1760639264309</time>
          <timezone>Etc/UTC</timezone>
        </lastModified>
        <description></description>
        <includeNewChannels>true</includeNewChannels>
        <enabledChannelIds>
          <string>400018df-285e-478c-941f-c2edc31739b1</string>
          <string>aaf33967-fc20-40f2-ac82-8f717f7e8fd1</string>
          <string>c4eae20f-4d1b-4ede-b600-8da565e0aec4</string>
          <string>86b3733a-bbcb-4e66-8019-288a694c18ca</string>
          <string>fd3bb3e4-37e1-4560-b778-ac9ad8684f85</string>
          <string>9494e43b-15ca-4655-aa7e-ffbc323d3921</string>
          <string>f9467c56-c662-46db-9455-5b3c7d269be1</string>
          <string>52615302-657d-4f39-910b-8a6c4c6dccf9</string>
        </enabledChannelIds>
        <disabledChannelIds/>
        <codeTemplates>
          <codeTemplate version="4.4.0">
            <id>517e983d-5deb-4ba8-bcf0-d60df1d028aa</id>
            <name>JsonECT</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547900174</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>CHANNEL_UNDEPLOY</contextType>
                <contextType>CHANNEL_DEPLOY</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>GLOBAL_PREPROCESSOR</contextType>
                <contextType>CHANNEL_BATCH</contextType>
                <contextType>CHANNEL_PREPROCESSOR</contextType>
                <contextType>GLOBAL_UNDEPLOY</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>GLOBAL_DEPLOY</contextType>
                <contextType>GLOBAL_POSTPROCESSOR</contextType>
                <contextType>CHANNEL_POSTPROCESSOR</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                <contextType>CHANNEL_ATTACHMENT</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function JsonECT() {
	return {
	    ECTKey:&quot;&quot;,
	    SessionKey:&quot;&quot;,
	    TreatNum:&quot;&quot;,
	    TreatTime:&quot;&quot;,
	    Error: false,
	    StaticOhms:&quot;&quot;,
	    Intensity:&quot;&quot;,
	    PulseWidthDelivered:&quot;&quot;,
	    FrequencyDelivered:&quot;&quot;,
	    DurationDelivered:&quot;&quot;,
	    CurrentDelivered:&quot;&quot;,
	    ChargeDelivered:&quot;&quot;,
	    EnergyDelivered:&quot;&quot;,
	    DynamicOhmsDelivered:&quot;&quot;,
	    EEGSeizureTime:&quot;&quot;,
	    MotorTime:&quot;&quot;,
	    EEGArtifacts:&quot;&quot;,
	    EEGAdequacy:&quot;&quot;,
	    EEGNote:&quot;&quot;,
	    EEGLevel:&quot;&quot;,
	    EEGChannels:&quot;&quot;,
	    EEGAge:&quot;&quot;,
	    EEGPlacement:&quot;&quot;,
	    EEGTreatNum:&quot;&quot;,
	    EEGMaintFlag:&quot;&quot;,
	    LogChannels:&quot;&quot;,
	    ChType:&quot;&quot;,
	    ChLabel:&quot;&quot;,
	    ChType:&quot;&quot;,
	    ChLabel:&quot;&quot;,
	    ChType:&quot;&quot;,
	    ChLabel:&quot;&quot;,
	    ChType:&quot;&quot;,
	    ChLabel:&quot;&quot;,
	    ChType:&quot;&quot;,
	    ChLabel:&quot;&quot;,
	    ChType:&quot;&quot;,
	    ChLabel:&quot;&quot;,
	    ChType:&quot;&quot;,
	    ChLabel:&quot;&quot;,
	    PulseWidthSetting:&quot;&quot;,
	    FrequencySetting:&quot;&quot;,
	    DurationSetting:&quot;&quot;,
	    CurrentSetting:&quot;&quot;,
	    ChargeSetting:&quot;&quot;,
	    EnergySetting:&quot;&quot;,
	    DynamicOhmsSetting:&quot;&quot;,
	    UserDef:&quot;&quot;,
	    UserDef:&quot;&quot;,
	    UserDef:&quot;&quot;,
	    UserDef:&quot;&quot;,
	    UserDef:&quot;&quot;,
	    UserDef:&quot;&quot;,
	    UserDef:&quot;&quot;,
	    UserDef:&quot;&quot;,
	    UserDef:&quot;&quot;,
	    UserDef:&quot;&quot;,
	    UniD: false,
	    ECT_State:&quot;&quot;,
	    ECT_Ver:&quot;&quot;,
	    ECT_FormID:&quot;&quot;,
	    Lock: false,
	    SerialNumber:&quot;&quot;,
	    ECTConfig:&quot;&quot;,
	    IntensityDelivered:&quot;&quot;,
	    ECTPlacement:&quot;&quot;
	}
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>0f43571b-48a9-4c0f-a597-45d14b980519</id>
            <name>JsonOutput</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547901833</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>CHANNEL_UNDEPLOY</contextType>
                <contextType>CHANNEL_DEPLOY</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>GLOBAL_PREPROCESSOR</contextType>
                <contextType>CHANNEL_BATCH</contextType>
                <contextType>CHANNEL_PREPROCESSOR</contextType>
                <contextType>GLOBAL_UNDEPLOY</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>GLOBAL_DEPLOY</contextType>
                <contextType>GLOBAL_POSTPROCESSOR</contextType>
                <contextType>CHANNEL_POSTPROCESSOR</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                <contextType>CHANNEL_ATTACHMENT</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function JsonOutput() {
	return {
		MRN:&quot;&quot;,
		GivenName:&quot;&quot;,
		FamilyName:&quot;&quot;,
		DateOfBirth:&quot;&quot;,
		Sex:&quot;&quot;,
		ECT:[]
	}
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>d8742cc6-1fe9-4e31-974f-4faa15d5dc89</id>
            <name>JsonOutput2</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547900086</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function JsonOutput2() {
	return {
		MRN:&quot;&quot;,
		GivenName:&quot;&quot;,
		FamilyName:&quot;&quot;,
		DateOfBirth:&quot;&quot;,
		Sex:&quot;&quot;,
		FrequencyDelivered:&quot;&quot;,
		FrequencySetting:&quot;&quot;,
		CurrentDelivered:&quot;&quot;,
		CurrentSetting:&quot;&quot;,
		PulseWidthDelivered:&quot;&quot;,   
		PulseWidthSetting:&quot;&quot;,
		DurationDelivered:&quot;&quot;,
		DurationSetting:&quot;&quot;,
		EnergyDelivered:&quot;&quot;,
		EnergySetting:&quot;&quot;,
		DynamicOhmsDelivered:&quot;&quot;,
		DynamicOhmsSetting:&quot;&quot;,	 
	     StaticOhms:&quot;&quot;,
	     Date:&quot;&quot;
	}
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>c4205762-2840-49d0-b0a6-d5e9de1fe7ee</id>
            <name>JsonPatient</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547900809</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>CHANNEL_UNDEPLOY</contextType>
                <contextType>CHANNEL_DEPLOY</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>GLOBAL_PREPROCESSOR</contextType>
                <contextType>CHANNEL_BATCH</contextType>
                <contextType>CHANNEL_PREPROCESSOR</contextType>
                <contextType>GLOBAL_UNDEPLOY</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>GLOBAL_DEPLOY</contextType>
                <contextType>GLOBAL_POSTPROCESSOR</contextType>
                <contextType>CHANNEL_POSTPROCESSOR</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                <contextType>CHANNEL_ATTACHMENT</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function JsonPatient() {
	return {
		MRN:&quot;&quot;,
		GivenName:&quot;&quot;,
		FamilyName:&quot;&quot;,
		DateOfBirth:&quot;&quot;,
		Sex:&quot;&quot;,
	}
}</code>
            </properties>
          </codeTemplate>
        </codeTemplates>
      </codeTemplateLibrary>
      <codeTemplateLibrary version="4.4.0">
        <id>bf6e6d4d-7708-4d8b-ae58-c027e10cb5d4</id>
        <name>Obx Parser</name>
        <revision>9</revision>
        <lastModified>
          <time>1760707836024</time>
          <timezone>Etc/UTC</timezone>
        </lastModified>
        <description></description>
        <includeNewChannels>true</includeNewChannels>
        <enabledChannelIds>
          <string>aaf33967-fc20-40f2-ac82-8f717f7e8fd1</string>
          <string>9494e43b-15ca-4655-aa7e-ffbc323d3921</string>
        </enabledChannelIds>
        <disabledChannelIds/>
        <codeTemplates>
          <codeTemplate version="4.4.0">
            <id>37e3e202-24ab-4723-80ff-cc4b35c97a80</id>
            <name>cleanMappedDischargeFields</name>
            <revision>1</revision>
            <lastModified>
              <time>1760707360209</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
// --- tiny utils ---
function s(v){ return (v==null)? &apos;&apos; : String(v).trim(); }
function isXmlLike(v){ v = s(v); return v.indexOf(&apos;&lt;OBX.5&apos;) !== -1; }
function matchObx5(xml, n){
  // returns the text inside &lt;OBX.5.n&gt;...&lt;/OBX.5.n&gt; or &apos;&apos;
  var re = new RegExp(&apos;&lt;OBX\\.5\\.&apos; + n + &apos;&gt;([\\s\\S]*?)&lt;\\/OBX\\.5\\.&apos; + n + &apos;&gt;&apos;, &apos;i&apos;);
  var m = s(xml).match(re);
  return m ? s(m[1]) : &apos;&apos;;
}

// Clean a TX note from OBX.5 (pulls OBX.5.1 if XML, else returns trimmed string)
function cleanNote(v){
  var t = s(v);
  if (!t) return null;
  if (!isXmlLike(t)) return t;
  var note = matchObx5(t, 1);
  return note || null;
}

// Build &quot;Hernandez, Maria J, MD (12345)&quot; from OBX.5 (XCN) XML or pass-through text
function cleanDoctor(v){
  var raw = s(v);
  if (!raw) return null;

  // If not XML, return as-is (already plain text)
  if (!isXmlLike(raw)) {
    if (/^none\s+recorded$/i.test(raw)) return &apos;None recorded&apos;;
    return raw;
  }

  // Extract components
  var id     = matchObx5(raw, 1);          // e.g., NPI/ID or free text
  var family = matchObx5(raw, 2);          // last
  var given  = matchObx5(raw, 3);          // first
  var middle = matchObx5(raw, 4);          // middle
  var suffix = matchObx5(raw, 5);          // suffix
  var degree = matchObx5(raw, 6);          // MD/DO

  if (/^none\s+recorded$/i.test(id)) return &apos;None recorded&apos;;

  // If only 5.1 present and it looks like a name (not pure digits), use it
  var hasNameBits = !!(family || given || middle || suffix || degree);
  if (!hasNameBits &amp;&amp; id &amp;&amp; !/^\d+$/.test(id)) return id;

  var name = &apos;&apos;;
  if (family) name += family;
  if (given)  name += (name ? &apos;, &apos; : &apos;&apos;) + given;
  if (middle) name += &apos; &apos; + middle;
  if (suffix) name += &apos;, &apos; + suffix;
  if (degree) name += &apos;, &apos; + degree;
  if (id)     name += &apos; (&apos; + id + &apos;)&apos;;

  return name || null;
}

// Clean all four mapped values already in the channelMap and overwrite them
function cleanMappedDischargeFields(){
  var note            = channelMap.get(&apos;Note&apos;);
  var admitting       = channelMap.get(&apos;AdmittingDoctor&apos;);
  var consulting      = channelMap.get(&apos;ConsultingDoctor&apos;);
  var discharge       = channelMap.get(&apos;DischargeDoctor&apos;);

  channelMap.put(&apos;Note&apos;, cleanNote(note));
  channelMap.put(&apos;AdmittingDoctor&apos;,  cleanDoctor(admitting));
  channelMap.put(&apos;ConsultingDoctor&apos;, cleanDoctor(consulting));
  channelMap.put(&apos;DischargeDoctor&apos;,  cleanDoctor(discharge));
}
</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>aff9848d-de7a-4c12-b2bd-dc526bbc8825</id>
            <name>getComp</name>
            <revision>1</revision>
            <lastModified>
              <time>1760706797215</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
// Read a text value from a component safely (returns &quot;&quot; if missing)
function getComp(node, compPath) {
    try {
        var n = node;
        var parts = compPath.split(&apos;.&apos;);
        for (var i = 0; i &lt; parts.length; i++) {
            n = n[parts[i]];
            if (!n) return &apos;&apos;;
        }
        var s = String(n);
        return s != null ? s.trim() : &apos;&apos;;
    } catch (e) {
        return &apos;&apos;;
    }
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>8efd540a-4168-4603-84eb-52b3c4e688a3</id>
            <name>mapDischargeOBX</name>
            <revision>4</revision>
            <lastModified>
              <time>1760706519841</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
 * Loop through all OBX segments and map:
 *  - Note (LOINC 18842-5 Discharge summary -&gt; OBX-5)
 *  - AdmittingDoctor (ADM_DOC -&gt; OBX-5 XCN)
 *  - ConsultingDoctor (CONS_DOC -&gt; OBX-5 XCN or &quot;None recorded&quot;)
 *  - DischargeDoctor (DIS_DOC -&gt; OBX-5 XCN)
 */
function mapDischargeOBX(root) {
    // clear / initialize (optional — comment out if you prefer to keep prior values)
    channelMap.put(&apos;Note&apos;, null);
    channelMap.put(&apos;AdmittingDoctor&apos;, null);
    channelMap.put(&apos;ConsultingDoctor&apos;, null);
    channelMap.put(&apos;DischargeDoctor&apos;, null);

    // msg.OBX is a repeating segment list in Mirth’s HL7 XML
    var count = (root.OBX ? root.OBX.length() : 0);

    for (var i = 0; i &lt; count; i++) {
        var obx = root.OBX[i];

        // OBX-3 (CE) – observation identifier
        var idCE1 = (obx[&apos;OBX.3&apos;][&apos;OBX.3.1&apos;] ? String(obx[&apos;OBX.3&apos;][&apos;OBX.3.1&apos;]) : &apos;&apos;).trim(); // code
        var idCE2 = (obx[&apos;OBX.3&apos;][&apos;OBX.3.2&apos;] ? String(obx[&apos;OBX.3&apos;][&apos;OBX.3.2&apos;]) : &apos;&apos;).trim(); // text
        // OBX-5 – observation value (for TX/NM/etc. we read as string)
        var val   = (obx[&apos;OBX.5&apos;] ? String(obx[&apos;OBX.5&apos;]) : &apos;&apos;).trim();
        
        if (!idCE1 &amp;&amp; !idCE2) continue;

        // Discharge Note (LOINC 18842-5 or text contains &quot;Discharge summary&quot;)
        if (idCE1 === &apos;18842-5&apos; || /discharge\s*summary/i.test(idCE2)) {
            // If multiple OBX for notes, join with a blank line
            var currentNote = channelMap.get(&apos;Note&apos;);
            if (currentNote &amp;&amp; String(currentNote).trim() !== &apos;&apos;) {
                channelMap.put(&apos;Note&apos;, String(currentNote) + &apos;\n\n&apos; + val);
            } else {
                channelMap.put(&apos;Note&apos;, val);
            }
            continue;
        }

        // Admitting doctor
        if (idCE1 === &apos;ADM_DOC&apos; || /admitting\s*doctor/i.test(idCE2)) {
            channelMap.put(&apos;AdmittingDoctor&apos;, formatXCN(val));
            continue;
        }

        // Consulting doctor
        if (idCE1 === &apos;CONS_DOC&apos; || /consulting\s*doctor/i.test(idCE2)) {
            channelMap.put(&apos;ConsultingDoctor&apos;, formatXCN(val));
            continue;
        }

        // Discharge doctor
        if (idCE1 === &apos;DIS_DOC&apos; || /discharge\s*doctor/i.test(idCE2)) {
            channelMap.put(&apos;DischargeDoctor&apos;, formatXCN(val));
            continue;
        }
    }

    // Optional: if consulting is still blank and OBX said &quot;None recorded&quot;, set explicitly
    if (!channelMap.get(&apos;ConsultingDoctor&apos;)) {
        // leave as null; consumer can treat null as &quot;unknown&quot;
    }
}</code>
            </properties>
          </codeTemplate>
        </codeTemplates>
      </codeTemplateLibrary>
      <codeTemplateLibrary version="4.4.0">
        <id>46f98a65-d504-4fc8-a295-7cf7b199b3c3</id>
        <name>SQL</name>
        <revision>21</revision>
        <lastModified>
          <time>1760886149549</time>
          <timezone>Etc/UTC</timezone>
        </lastModified>
        <description></description>
        <includeNewChannels>false</includeNewChannels>
        <enabledChannelIds>
          <string>aaf33967-fc20-40f2-ac82-8f717f7e8fd1</string>
          <string>9494e43b-15ca-4655-aa7e-ffbc323d3921</string>
        </enabledChannelIds>
        <disabledChannelIds/>
        <codeTemplates>
          <codeTemplate version="4.4.0">
            <id>72385f14-0abe-4016-b02a-7c35cd14f65d</id>
            <name>addProvider</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547900037</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function addProvider() {

	   var json = {};
	   json.FullName = &quot;Joe Smith&quot;;
	   json.ProviderId = &quot;jsmith&quot;;       
        insertQueryBuilder(json,&quot;Providers&quot;);

}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>86a077ed-f722-4666-812b-fb7f9de7ece8</id>
            <name>executeQueryAndFormatResult</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547902188</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>CHANNEL_UNDEPLOY</contextType>
                <contextType>CHANNEL_DEPLOY</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>GLOBAL_PREPROCESSOR</contextType>
                <contextType>CHANNEL_BATCH</contextType>
                <contextType>CHANNEL_PREPROCESSOR</contextType>
                <contextType>GLOBAL_UNDEPLOY</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>GLOBAL_DEPLOY</contextType>
                <contextType>GLOBAL_POSTPROCESSOR</contextType>
                <contextType>CHANNEL_POSTPROCESSOR</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                <contextType>CHANNEL_ATTACHMENT</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function executeQueryAndFormatResult(queryString, colDelim, rowDelim) {
  try {
    var env = JSON.parse(configurationMap.get(&quot;settings&quot;));
    var dbConn = DatabaseConnectionFactory.createDatabaseConnection(&apos;net.sourceforge.jtds.jdbc.Driver&apos;, env.Databases.default.connectionstring, env.Databases.default.user, env.Databases.default.password); 
//    logger.debug(queryString)
    const result = dbConn.executeCachedQuery(queryString);
    return formatSqlResult(result, colDelim, rowDelim);
  } finally {
    if (result) {
       result.close();
    }
  }
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>676d657a-f3c4-46d5-894b-07564d265861</id>
            <name>formatSqlResult</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547902219</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>CHANNEL_UNDEPLOY</contextType>
                <contextType>CHANNEL_DEPLOY</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>GLOBAL_PREPROCESSOR</contextType>
                <contextType>CHANNEL_BATCH</contextType>
                <contextType>CHANNEL_PREPROCESSOR</contextType>
                <contextType>GLOBAL_UNDEPLOY</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>GLOBAL_DEPLOY</contextType>
                <contextType>GLOBAL_POSTPROCESSOR</contextType>
                <contextType>CHANNEL_POSTPROCESSOR</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                <contextType>CHANNEL_ATTACHMENT</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function formatSqlResult(result, colDelim, rowDelim) {
   const columnCount = result.getMetaData().getColumnCount();
   const lines = [];
   var rsmd = result.getMetaData();
   while (result.next()) {
      const row = [];
      row.length = columnCount; // Allows JS engine to reserve the needed number of entries ahead of time
      for (let i = 1; i &lt;= columnCount; i++) {
      	var colomn = rsmd.getColumnName(i).toString();
         row[i-1] = &apos;&quot;&apos; + colomn + &apos;&quot;:&quot;&apos; + result.getString(i) + &apos;&quot;&apos;;
      }
      var field = &quot;{&quot; + row + &quot;}&quot;
//      logger.debug(&quot;ROW: &quot; + field)
//      lines.push(row.join(colDelim));
      lines.push(JSON.parse(field));
   }
//   return lines.join(rowDelim);
   return lines;
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>55b03bce-55d3-445e-8dbc-c8dcd15257bc</id>
            <name>getConnectionstring</name>
            <revision>2</revision>
            <lastModified>
              <time>1760552402697</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function getConnectionstring(server) {
var config = JSON.parse(configurationMap.get(&quot;settings&quot;));
var connectionString =config.connectionString;

return connectionString;
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>b8d29482-7dfc-4bc9-8963-d0f86eec89e4</id>
            <name>getCourse</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547900903</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function getCourse(patientKey) {
	var query = &quot;SELECT * FROM tblCourse WHERE PatientKey=&apos;&quot; + patientKey + &quot;&apos;&quot;;
//     var result = selectQueryBuilder(query);
     var result = executeQueryAndFormatResult(query,&quot;,&quot;,&quot;\n&quot;)
//     logger.debug(&quot;Result 2: &quot; + JSON.stringify(result))
	return result;
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>a534f56d-cd4a-4c96-a68d-3034ea05e8b1</id>
            <name>getECT</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547901273</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function getECT(sessionKey) {
	var query = &quot;SELECT * FROM tblECT WHERE SessionKey=&apos;&quot; + sessionKey + &quot;&apos;&quot;;
     var result = selectQueryBuilder(query);
	return result;
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>58150850-fb96-44c8-b931-36c26e7db425</id>
            <name>getHospital</name>
            <revision>2</revision>
            <lastModified>
              <time>1760882738348</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function getHospital(name, TenantKey) {
	var query = &quot;SELECT * FROM [he].[Hospital] WHERE [HospitalName]=&apos;&quot; + name + &quot;&apos; AND [TenantKey] =&apos;&quot; + TenantKey + &quot;&apos;&quot;;
     var result = selectQueryBuilder(query);
     
	return result;
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>b9fe5065-3068-40d0-80db-9918e6ff0fe9</id>
            <name>getPatiens</name>
            <revision>2</revision>
            <lastModified>
              <time>1760553416835</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function getPatiens() {
// ---- DB config (keep secrets out of code; pull from Global Map / Deployed props) ----
var driver = &apos;com.microsoft.sqlserver.jdbc.SQLServerDriver&apos;;
var url =
  &apos;jdbc:sqlserver://he-sql-dev-eus2.database.windows.net:1433;&apos; +
  &apos;database=he-healthcare-db;&apos; +                      // or databaseName=...
  &apos;encrypt=true;trustServerCertificate=false;&apos; +
  &apos;hostNameInCertificate=*.database.windows.net;&apos; +
  &apos;loginTimeout=30;&apos;;
//User ID=headmin;Password=HealthExt2025!
var user = String(globalMap.get(&apos;HE_DB_USER&apos;) || &apos;headmin&apos;);
var pass = String(globalMap.get(&apos;HE_DB_PASS&apos;) || &apos;HealthExt2025!&apos;);

// ---- Open connection using the 4-arg overload ----
var db = null;
try {
    db = DatabaseConnectionFactory.createDatabaseConnection(driver, url, user, pass);

    // EXAMPLE: parameterized query
    var sql = &quot;SELECT * FROM dbo.Patient WHERE Id = ?&quot;;
    var params = [ String(channelMap.get(&apos;patientId&apos;) || &apos;4&apos;) ];

    var rs = db.executeCachedQuery(sql, params);  // returns CachedRowSet
    if (rs.next()) {
        var pid  = rs.getString(&apos;Id&apos;);
        var fn   = rs.getString(&apos;FirstName&apos;);
        var ln   = rs.getString(&apos;LastName&apos;);
        var dob  = rs.getString(&apos;DateOfBirth&apos;);

        channelMap.put(&apos;dbPatientId&apos;, pid);
        channelMap.put(&apos;dbFirstName&apos;, fn);
        channelMap.put(&apos;dbLastName&apos;,  ln);
        channelMap.put(&apos;dbDOB&apos;,       dob);
    } else {
        logger.warn(&apos;No patient row found for Id=&apos; + params[0]);
    }
} catch (e) {
    logger.error(&apos;DB error: &apos; + e);
    throw e; // or handle as needed
} finally {
    if (db) try { db.close(); } catch (ignore) {}
}

}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>f88de46e-16ad-4a9c-8a5a-bc46ba471677</id>
            <name>getPatient</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547900967</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function getPatient(name,mrn) {
	var query = &quot;SELECT * FROM tblPatient WHERE Name=&apos;&quot; + name + &quot;&apos; AND MRN=&apos;&quot; + mrn + &quot;&apos;&quot;;
     var result = selectQueryBuilder(query);
     
	return result;
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>4bb41cb8-4799-4065-8764-6ca867c7f1a2</id>
            <name>getPatientKey</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547900665</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function getPatientKey(MRN) {
	//var query = &quot;SELECT * FROM tblPatient ORDER BY PatientKey Desc&quot;;
	var query = &quot;SELECT *&quot;;
	query +=&quot; FROM   [tblPatient]&quot;;
	query +=&quot; WHERE  ([tblPatient].[MRN] =&apos;&quot; + MRN + &quot;&apos;) AND NOT EXISTS (SELECT [PatientKey] FROM [tblHL7] WHERE  [tblPatient].[PatientKey] = [tblHL7].[PatientKey])&quot;;
	query +=&quot; ORDER BY [PatientKey]&quot;;
//	logger.debug(&quot;Query: &quot; + query)
     var result = selectQueryBuilder(query);
	return result;
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>4a573c8a-c9e5-4161-bec3-aa0405a6e0c3</id>
            <name>getPostNursing</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547901391</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>CHANNEL_UNDEPLOY</contextType>
                <contextType>CHANNEL_DEPLOY</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>GLOBAL_PREPROCESSOR</contextType>
                <contextType>CHANNEL_BATCH</contextType>
                <contextType>CHANNEL_PREPROCESSOR</contextType>
                <contextType>GLOBAL_UNDEPLOY</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>GLOBAL_DEPLOY</contextType>
                <contextType>GLOBAL_POSTPROCESSOR</contextType>
                <contextType>CHANNEL_POSTPROCESSOR</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                <contextType>CHANNEL_ATTACHMENT</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function getPostNursing(sessionKey) {
	var query = &quot;SELECT * FROM tblECT WHERE SessionKey=&apos;&quot; + sessionKey + &quot;&apos;&quot;;
     var result = selectQueryBuilder(query);
	return result;
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>b73aece2-72ef-46ea-9ec8-2ebb6b7f8f4e</id>
            <name>getProviders</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547900341</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function getProvider() {

     var query = &quot;SELECT * FROM Providers&quot;;
     var result = selectQueryBuilder(query);
	return result;

}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>346bbf6a-7a42-4765-9608-bc2f4bb0b4d4</id>
            <name>getSession</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547901069</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function getSession(courseKey) {
	var query = &quot;SELECT * FROM tblSession WHERE CourseKey=&apos;&quot; + courseKey + &quot;&apos;&quot;;
     var result = selectQueryBuilder(query);
	return result;
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>7d1d349a-e4f6-4867-b2e3-83aedd6af28c</id>
            <name>insertQueryBuilder</name>
            <revision>9</revision>
            <lastModified>
              <time>1760635088064</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function insertQueryBuilder(query) {
	var env = JSON.parse(configurationMap.get(&quot;settings&quot;));
        var driver  = &apos;net.sourceforge.jtds.jdbc.Driver&apos;;
        var jdbcUrl = &apos;jdbc:jtds:sqlserver://he-sql-dev-eus2.database.windows.net:1433/he-healthcare-db;&apos; +
                      &apos;ssl=require;loginTimeout=30;&apos;;
        var user    = &apos;headmin&apos;;
        var pass    = &apos;HealthExt2025!&apos;;

        dbConn = DatabaseConnectionFactory.createDatabaseConnection(driver, jdbcUrl, user, pass);
    var result
    try {
//    	 logger.debug(&quot;query: &quot; + query)
	result = dbConn.executeUpdate(query);
     dbConn.close();
    } finally {
        if (dbConn) {
            dbConn.close();
        }
        return result;
    }
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>2e74aa6a-16e7-4730-a1d7-ca43283a5e19</id>
            <name>selectQueryBuilder</name>
            <revision>11</revision>
            <lastModified>
              <time>1760749733974</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>GLOBAL_PREPROCESSOR</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>GLOBAL_UNDEPLOY</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>GLOBAL_DEPLOY</contextType>
                <contextType>GLOBAL_POSTPROCESSOR</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>function selectQueryBuilder(query) {
//    var DatabaseConnectionFactory = Packages.com.mirth.connect.server.userutil.DatabaseConnectionFactory;
    var dbConn = null;
    var rs = null;

    try {
        // If you keep creds in configurationMap settings, pull them here (optional)
        // var env = JSON.parse(configurationMap.get(&quot;settings&quot;) || &quot;{}&quot;);

        // jTDS example (works with Azure SQL; Microsoft driver is recommended for prod)
        var driver  = &apos;net.sourceforge.jtds.jdbc.Driver&apos;;
        var jdbcUrl = &apos;jdbc:jtds:sqlserver://he-sql-dev-eus2.database.windows.net:1433/he-healthcare-db;&apos; +
                      &apos;ssl=require;loginTimeout=30;&apos;;
        var user    = &apos;headmin&apos;;
        var pass    = &apos;HealthExt2025!&apos;;

        dbConn = DatabaseConnectionFactory.createDatabaseConnection(driver, jdbcUrl, user, pass);

        rs = dbConn.executeCachedQuery(query);
        var rsmd = rs.getMetaData();
        var colCount = rsmd.getColumnCount();

        var rows = [];

        while (rs.next()) {
            var row = {};
            for (var i = 1; i &lt;= colCount; i++) {
                var columnName = String(rsmd.getColumnName(i));
                var value = rs.getString(i); // String or null; preserves your desired representation
                row[columnName] = (value === null) ? null : String(value);
            }
            rows.push(row);
        }

        return rows; // e.g. [{&quot;PatientKey&quot;:&quot;4&quot;,&quot;TenantKey&quot;:&quot;1&quot;,...}]
    } catch (err) {
        logger.debug(&apos;DB select error: &apos; + err);
//        logger.debug(&quot;Slect Error: &quot; + query)
        return [];
    } finally {
        try { if (rs) rs.close(); } catch (e1) {}
        try { if (dbConn) dbConn.close(); } catch (e2) {}
    }
}
</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>e056f89d-d7c8-4a96-b855-4940ecdf4388</id>
            <name>selectQueryBuilderBK</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547899575</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function selectQueryBuilderBK(query) {
	try{
		var env = JSON.parse(configurationMap.get(&quot;settings&quot;));
	   var dbConn = DatabaseConnectionFactory.createDatabaseConnection(&apos;net.sourceforge.jtds.jdbc.Driver&apos;, env.Databases.default.connectionstring, env.Databases.default.user, env.Databases.default.password); 
        var result = dbConn.executeCachedQuery(query);
        var rsmd = result.getMetaData();
        result.next();
        var values =[];
        var count = rsmd.getColumnCount()+1;

        var fieldString = &apos;{&apos;;
        for(var j = 1; j&lt;count; ++j){
        	var colomn = rsmd.getColumnName(j).toString();
        	var field = {};
	     field[colomn] = result.getString(colomn);
	     fieldString +=  colomn + &quot;:&quot; + result.getString(colomn) + &quot;,&quot;
	     values.push(field);
//	     logger.debug(&quot;Field Result : &quot; + result.getString())
//        	logger.debug(colomn + &quot; : &quot; + result.getString(j))
        }
         fieldString += &quot;}&quot;;
//         logger.debug(&quot;fieldString : &quot; + fieldString)
        return values;
	}catch(err){
		return []
	}



	   
        

}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>641e684f-abab-41af-96a9-f1f11a66b96e</id>
            <name>updateEncounter</name>
            <revision>17</revision>
            <lastModified>
              <time>1760887914250</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
 * Update an existing Encounter row with fields provided in `encounter`.
 * Match key: TenantKey + HospitalKey + PatientKey + VisitNumber
 * - Only non-null/meaningful values are updated (no overwriting with blanks).
 * - Automatically sets LastUpdatedUtc = SYSUTCDATETIME().
 */
function updateEncounter(encounter) {
  // ---------- helpers ----------
  function esc(val) { return (val == null) ? null : String(val).replace(/&apos;/g, &quot;&apos;&apos;&quot;); }
  function hasVal(v) { return !(v == null || String(v).trim() === &quot;&quot;); }
  function toSqlStr(val) { return hasVal(val) ? &quot;&apos;&quot; + esc(String(val).trim()) + &quot;&apos;&quot; : null; }
  function toSqlInt(val) {
    if (val == null || String(val).trim() === &quot;&quot;) return null;
    var n = Number(val);
    return isNaN(n) ? null : String(Math.trunc(n));
  }
  function toSqlBit(val) {
    if (val === 0 || val === &quot;0&quot; || val === false || String(val).toLowerCase() === &quot;false&quot;) return &quot;0&quot;;
    if (val === 1 || val === &quot;1&quot; || val === true  || String(val).toLowerCase() === &quot;true&quot;)  return &quot;1&quot;;
    return null;
  }
  function toSqlDateTime(val) {
    if (!hasVal(val)) return null;
    var s = String(val).trim().replace(&apos;T&apos;,&apos; &apos;);
    return &quot;&apos;&quot; + esc(s) + &quot;&apos;&quot;;
  }
  function add(assignments, column, sqlVal) {
    if (sqlVal !== null &amp;&amp; sqlVal !== undefined) assignments.push(&quot;[&quot; + column + &quot;] = &quot; + sqlVal);
  }

  // ---------- keys (required) ----------
  var whereParts = [];
  add(whereParts, &quot;TenantKey&quot;, toSqlStr(encounter.TenantKey));
  add(whereParts, &quot;HospitalKey&quot;, toSqlInt(encounter.HospitalKey));
  add(whereParts, &quot;PatientKey&quot;, toSqlInt(encounter.PatientKey));
  add(whereParts, &quot;AdmitDateTime&quot;, toSqlStr(encounter.AdmitDateTime));
  add(whereParts, &quot;Location&quot;, toSqlStr(encounter.Location));

  if (whereParts.length !== 4) {
    throw &quot;updateEncounter: missing key(s). Required: TenantKey, HospitalKey, PatientKey, VisitNumber.&quot;;
  }

  // ---------- SET list (only what you pass) ----------
  var setParts = [];

  // Core timing
  //add(setParts, &quot;AdmitDateTime&quot;,        toSqlDateTime(encounter.AdmitDateTime));
  add(setParts, &quot;DischargeDateTime&quot;,    toSqlDateTime(encounter.DischargeDateTime));

  // Class/location/detail
  add(setParts, &quot;PatientClass&quot;,         toSqlStr(encounter.PatientClass));
  //add(setParts, &quot;Location&quot;,             toSqlStr(encounter.Location));
  //add(setParts, &quot;AdmitType&quot;,            toSqlStr(encounter.AdmitType));
  //add(setParts, &quot;AdmitSource&quot;,          toSqlStr(encounter.AdmitSource));
  add(setParts, &quot;VisitStatus&quot;,          toSqlStr(encounter.VisitStatus));
  add(setParts, &quot;Notes&quot;,                toSqlStr(encounter.Notes));

  // Provider display strings
  add(setParts, &quot;AttendingDoctor&quot;,      toSqlStr(encounter.AttendingDoctor));
  add(setParts, &quot;AdmittingDoctor&quot;,      toSqlStr(encounter.AdmittingDoctor));
  add(setParts, &quot;PrimaryDoctor&quot;,        toSqlStr(encounter.PrimaryDoctor));

  // Message IDs
 // add(setParts, &quot;AdmitMessageId&quot;,       toSqlStr(encounter.AdmitMessageId));
  add(setParts, &quot;DischargeMessageId&quot;,   toSqlStr(encounter.DischargeMessageId));

  // Discharge / Diagnosis
  add(setParts, &quot;DischargeDispositionCode&quot;, toSqlStr(encounter.DischargeDispositionCode));
  add(setParts, &quot;PrincipalDiagnosisCode&quot;,   toSqlStr(encounter.PrincipalDiagnosisCode));

  // Care transition / TCM
  var obsBit = toSqlBit(encounter.ObservationFlag); if (obsBit !== null) add(setParts, &quot;ObservationFlag&quot;, obsBit);
  add(setParts, &quot;FollowUpProviderKey&quot;,      toSqlInt(encounter.FollowUpProviderKey));
  add(setParts, &quot;FollowUpApptDateTime&quot;,     toSqlDateTime(encounter.FollowUpApptDateTime));
  add(setParts, &quot;CommunicationSentDate&quot;,    toSqlDateTime(encounter.CommunicationSentDate));
  add(setParts, &quot;TCMContactDate&quot;,           toSqlDateTime(encounter.TCMContactDate));
  add(setParts, &quot;TCMMethod&quot;,                toSqlStr(encounter.TCMMethod));
  add(setParts, &quot;HandoffAcknowledgedDate&quot;,  toSqlDateTime(encounter.HandoffAcknowledgedDate));
  add(setParts, &quot;ReadmissionSourceEncKey&quot;,  toSqlInt(encounter.ReadmissionSourceEncKey));

  // Payer context
  add(setParts, &quot;PayerName&quot;,                toSqlStr(encounter.PayerName));
  add(setParts, &quot;MemberId&quot;,                 toSqlStr(encounter.MemberId));

  // Provider FKs
  add(setParts, &quot;AttendingProviderKey&quot;,     toSqlInt(encounter.AttendingProviderKey));
  add(setParts, &quot;AdmittingProviderKey&quot;,     toSqlInt(encounter.AdmittingProviderKey));
  add(setParts, &quot;DischargeProviderKey&quot;,     toSqlInt(encounter.DischargeProviderKey));

  // Status
  var statusInt = toSqlInt(encounter.Status);
  if (statusInt !== null) add(setParts, &quot;Status&quot;, statusInt);

  // Always touch audit column
  setParts.push(&quot;[LastUpdatedUtc] = SYSUTCDATETIME()&quot;);

  if (setParts.length === 0) {
    logger.warn(&quot;updateEncounter: nothing to update.&quot;);
    return null;
  }

  var updateQuery =
    &quot;UPDATE [he].[Encounter] SET &quot; + setParts.join(&quot;, &quot;) +
    &quot; WHERE &quot; + whereParts.join(&quot; AND &quot;) + &quot;;&quot;;

  // logger.debug(&quot;SQL Update Query: &quot; + updateQuery);
  var resp = updateQueryBuilder(updateQuery);
  return resp;
}
</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>54fb371d-1d48-4d0c-80ac-b9ad12e2284c</id>
            <name>updateEncounter_bk</name>
            <revision>1</revision>
            <lastModified>
              <time>1760885936026</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function updateEncounter_bk(encounter) {
	// TODO: Enter code here
	var updateQuery = &quot;UPDATE [he].[Encounter] SET &quot;
      updateQuery += &quot;[DischargeDateTime] = &apos;&quot; + encounter.DischargeDateTime + &quot;&apos; ,&quot;;
      updateQuery += &quot;[AttendingDoctor] = &apos;&quot; + encounter.AttendingDoctor + &quot;&apos; ,&quot;;
      updateQuery += &quot;[VisitStatus] = &apos;&quot; + encounter.VisitStatus + &quot;&apos; ,&quot;;
      updateQuery += &quot;[PrimaryDoctor] = &apos;&quot; + encounter.PrimaryDoctor + &quot;&apos; ,&quot;;
      updateQuery += &quot;[AdmittingDoctor] = &apos;&quot; + encounter.AdmittingDoctor + &quot;&apos; ,&quot;;
      updateQuery += &quot;[Notes] = &apos;&quot; + encounter.Notes + &quot;&apos; ,&quot;;
      updateQuery += &quot;[DischargeMessageId] = &apos;&quot; + encounter.DischargeMessageId + &quot;&apos; &quot;;
 	 updateQuery += &quot;WHERE [AdmitDateTime] =&apos;&quot; + encounter.AdmitDateTime + &quot;&apos; AND  [PatientKey] =&apos;&quot; + encounter.PatientKey + &quot;&apos; AND [TenantKey] =&apos;&quot; + encounter.TenantKey + &quot;&apos;&quot;;

//logger.debug(&quot;SQL Update Query: &quot; + updateQuery)
	var newPatientResponse = updateQueryBuilder(updateQuery)
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>1d5f58e1-56cc-4c75-b231-a259f80c1bdf</id>
            <name>updateQueryBuilder</name>
            <revision>2</revision>
            <lastModified>
              <time>1760639479501</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function updateQueryBuilder(query) {
	var env = JSON.parse(configurationMap.get(&quot;settings&quot;));
        var driver  = &apos;net.sourceforge.jtds.jdbc.Driver&apos;;
        var jdbcUrl = &apos;jdbc:jtds:sqlserver://he-sql-dev-eus2.database.windows.net:1433/he-healthcare-db;&apos; +
                      &apos;ssl=require;loginTimeout=30;&apos;;
        var user    = &apos;headmin&apos;;
        var pass    = &apos;HealthExt2025!&apos;;

        dbConn = DatabaseConnectionFactory.createDatabaseConnection(driver, jdbcUrl, user, pass);
    var result

    try {
        result = dbConn.executeUpdate(query); // rows affected
        return result;
    } catch (e) {
        logger.error(&apos;updateQueryBuilder error: &apos; + e);
        throw e;
    } finally {
        if (dbConn) {
            try { dbConn.close(); } catch (ignore) {}
        }
    }
}
</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>b908d2c5-4f16-4b09-a178-1f980a09f432</id>
            <name>upsertEncounter</name>
            <revision>15</revision>
            <lastModified>
              <time>1760885212359</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
 * Upsert Encounter into he.Encounter using MERGE
 * Match key: TenantKey + HospitalKey + VisitNumber
 * Will NOT overwrite existing non-null values with nulls (COALESCE).
 *
 * Expected fields in `encounter` (strings unless noted):
 * TenantKey, HospitalKey (int), PatientKey (int), VisitNumber,
 * AdmitDateTime, DischargeDateTime,
 * PatientClass, Location, AdmitType, AdmitSource,
 * VisitStatus, Notes,
 * AttendingDoctor, AdmittingDoctor, PrimaryDoctor,
 * AdmitMessageId, DischargeMessageId,
 * DischargeDispositionCode, PrincipalDiagnosisCode,
 * ObservationFlag (0|1),
 * FollowUpProviderKey (int), FollowUpApptDateTime,
 * CommunicationSentDate, TCMContactDate, TCMMethod, HandoffAcknowledgedDate,
 * ReadmissionSourceEncKey (int),
 * PayerName, MemberId,
 * AttendingProviderKey (int), AdmittingProviderKey (int), DischargeProviderKey (int),
 * Status (int)
 */
function upsertEncounter(encounter) {
  // ---------- helpers ----------
  function esc(val) {
    return (val == null) ? null : String(val).replace(/&apos;/g, &quot;&apos;&apos;&quot;);
  }
  function toSqlStr(val) {
    if (val == null) return &quot;NULL&quot;;
    var s = String(val).trim();
    return s === &quot;&quot; ? &quot;NULL&quot; : &quot;&apos;&quot; + esc(s) + &quot;&apos;&quot;;
  }
  function toSqlInt(val) {
    if (val == null || String(val).trim() === &quot;&quot;) return &quot;NULL&quot;;
    var n = Number(val);
    return isNaN(n) ? &quot;NULL&quot; : String(Math.trunc(n));
  }
  function toSqlBit(val) {
    if (val === true || String(val).toLowerCase() === &quot;true&quot; || val === 1 || String(val) === &quot;1&quot;) return &quot;1&quot;;
    if (val === 0 || val === false || String(val) === &quot;0&quot; || String(val).toLowerCase() === &quot;false&quot;) return &quot;0&quot;;
    return &quot;NULL&quot;;
  }
  function toSqlDateTime(val) {
    // Accepts ISO-like strings &apos;YYYY-MM-DDTHH:MM:SS&apos; or &apos;YYYY-MM-DD HH:MM:SS&apos; or &apos;YYYY-MM-DD&apos;
    if (val == null) return &quot;NULL&quot;;
    var s = String(val).trim();
    if (s === &quot;&quot;) return &quot;NULL&quot;;
    // Replace &apos;T&apos; with space for SQL Server
    s = s.replace(&apos;T&apos;, &apos; &apos;);
    return &quot;&apos;&quot; + esc(s) + &quot;&apos;&quot;;
  }

  // ---------- project to SQL literals ----------
  var TenantKey               = toSqlStr(encounter.TenantKey);
  var HospitalKey             = toSqlInt(encounter.HospitalKey);
  var PatientKey              = toSqlInt(encounter.PatientKey);
  var VisitNumber             = toSqlStr(encounter.VisitNumber);

  var AdmitDateTime           = toSqlDateTime(encounter.AdmitDateTime);
  var DischargeDateTime       = toSqlDateTime(encounter.DischargeDateTime);

  var PatientClass            = toSqlStr(encounter.PatientClass);
  var Location                = toSqlStr(encounter.Location);
  var AdmitType               = toSqlStr(encounter.AdmitType);
  var AdmitSource             = toSqlStr(encounter.AdmitSource);

  var VisitStatus             = toSqlStr(encounter.VisitStatus);
  var Notes                   = toSqlStr(encounter.Notes);

  var AttendingDoctor         = toSqlStr(encounter.AttendingDoctor);
  var AdmittingDoctor         = toSqlStr(encounter.AdmittingDoctor);
  var PrimaryDoctor           = toSqlStr(encounter.PrimaryDoctor);

  var AdmitMessageId          = toSqlStr(encounter.AdmitMessageId);
  var DischargeMessageId      = toSqlStr(encounter.DischargeMessageId);

  var DischargeDispositionCode= toSqlStr(encounter.DischargeDispositionCode);
  var PrincipalDiagnosisCode  = toSqlStr(encounter.PrincipalDiagnosisCode);

  var ObservationFlag         = toSqlBit(encounter.ObservationFlag);

  var FollowUpProviderKey     = toSqlInt(encounter.FollowUpProviderKey);
  var FollowUpApptDateTime    = toSqlDateTime(encounter.FollowUpApptDateTime);

  var CommunicationSentDate   = toSqlDateTime(encounter.CommunicationSentDate);
  var TCMContactDate          = toSqlDateTime(encounter.TCMContactDate);
  var TCMMethod               = toSqlStr(encounter.TCMMethod);
  var HandoffAcknowledgedDate = toSqlDateTime(encounter.HandoffAcknowledgedDate);

  var ReadmissionSourceEncKey = toSqlInt(encounter.ReadmissionSourceEncKey);

  var PayerName               = toSqlStr(encounter.PayerName);
  var MemberId                = toSqlStr(encounter.MemberId);

  var AttendingProviderKey    = toSqlInt(encounter.AttendingProviderKey);
  var AdmittingProviderKey    = toSqlInt(encounter.AdmittingProviderKey);
  var DischargeProviderKey    = toSqlInt(encounter.DischargeProviderKey);

  var Status                  = toSqlInt(encounter.Status != null ? encounter.Status : 1); // default 1

  // ---------- source SELECT for MERGE ----------
  var src =
    &quot;SELECT &quot; +
    TenantKey               + &quot; AS TenantKey, &quot; +
    HospitalKey             + &quot; AS HospitalKey, &quot; +
    PatientKey              + &quot; AS PatientKey, &quot; +
    VisitNumber             + &quot; AS VisitNumber, &quot; +
    AdmitDateTime           + &quot; AS AdmitDateTime, &quot; +
    DischargeDateTime       + &quot; AS DischargeDateTime, &quot; +
    PatientClass            + &quot; AS PatientClass, &quot; +
    Location                + &quot; AS Location, &quot; +
    AdmitType               + &quot; AS AdmitType, &quot; +
    AdmitSource             + &quot; AS AdmitSource, &quot; +
    VisitStatus             + &quot; AS VisitStatus, &quot; +
    Notes                   + &quot; AS Notes, &quot; +
    AttendingDoctor         + &quot; AS AttendingDoctor, &quot; +
    AdmittingDoctor         + &quot; AS AdmittingDoctor, &quot; +
    PrimaryDoctor           + &quot; AS PrimaryDoctor, &quot; +
    AdmitMessageId          + &quot; AS AdmitMessageId, &quot; +
    DischargeMessageId      + &quot; AS DischargeMessageId, &quot; +
    DischargeDispositionCode+ &quot; AS DischargeDispositionCode, &quot; +
    PrincipalDiagnosisCode  + &quot; AS PrincipalDiagnosisCode, &quot; +
    ObservationFlag         + &quot; AS ObservationFlag, &quot; +
    FollowUpProviderKey     + &quot; AS FollowUpProviderKey, &quot; +
    FollowUpApptDateTime    + &quot; AS FollowUpApptDateTime, &quot; +
    CommunicationSentDate   + &quot; AS CommunicationSentDate, &quot; +
    TCMContactDate          + &quot; AS TCMContactDate, &quot; +
    TCMMethod               + &quot; AS TCMMethod, &quot; +
    HandoffAcknowledgedDate + &quot; AS HandoffAcknowledgedDate, &quot; +
    ReadmissionSourceEncKey + &quot; AS ReadmissionSourceEncKey, &quot; +
    PayerName               + &quot; AS PayerName, &quot; +
    MemberId                + &quot; AS MemberId, &quot; +
    AttendingProviderKey    + &quot; AS AttendingProviderKey, &quot; +
    AdmittingProviderKey    + &quot; AS AdmittingProviderKey, &quot; +
    DischargeProviderKey    + &quot; AS DischargeProviderKey, &quot; +
    Status                  + &quot; AS Status&quot;;

  // ---------- MERGE ----------
  var merge =
    &quot;MERGE he.Encounter AS tgt \n&quot; +
    &quot;USING (&quot; + src + &quot;) AS src \n&quot; +
    &quot;  ON (tgt.TenantKey = src.TenantKey \n&quot; +
    &quot;      AND tgt.HospitalKey = src.HospitalKey \n&quot; +
    &quot;      AND tgt.PatientKey = src.PatientKey \n&quot; +
    &quot;      AND tgt.AdmitDateTime = src.AdmitDateTime \n&quot; +
    &quot;      AND tgt.VisitNumber = src.VisitNumber)\n&quot; +
    &quot;WHEN MATCHED THEN UPDATE SET \n&quot; +
    // Use COALESCE to avoid wiping values with NULL
    &quot;  tgt.PatientKey              = COALESCE(src.PatientKey, tgt.PatientKey),\n&quot; +
    &quot;  tgt.AdmitDateTime           = COALESCE(src.AdmitDateTime, tgt.AdmitDateTime),\n&quot; +
    &quot;  tgt.DischargeDateTime       = COALESCE(src.DischargeDateTime, tgt.DischargeDateTime),\n&quot; +
    &quot;  tgt.PatientClass            = COALESCE(src.PatientClass, tgt.PatientClass),\n&quot; +
    &quot;  tgt.Location                = COALESCE(src.Location, tgt.Location),\n&quot; +
    &quot;  tgt.AdmitType               = COALESCE(src.AdmitType, tgt.AdmitType),\n&quot; +
    &quot;  tgt.AdmitSource             = COALESCE(src.AdmitSource, tgt.AdmitSource),\n&quot; +
    &quot;  tgt.VisitStatus             = COALESCE(src.VisitStatus, tgt.VisitStatus),\n&quot; +
    &quot;  tgt.Notes                   = COALESCE(src.Notes, tgt.Notes),\n&quot; +
    &quot;  tgt.AttendingDoctor         = COALESCE(src.AttendingDoctor, tgt.AttendingDoctor),\n&quot; +
    &quot;  tgt.AdmittingDoctor         = COALESCE(src.AdmittingDoctor, tgt.AdmittingDoctor),\n&quot; +
    &quot;  tgt.PrimaryDoctor           = COALESCE(src.PrimaryDoctor, tgt.PrimaryDoctor),\n&quot; +
    &quot;  tgt.AdmitMessageId          = COALESCE(src.AdmitMessageId, tgt.AdmitMessageId),\n&quot; +
    &quot;  tgt.DischargeMessageId      = COALESCE(src.DischargeMessageId, tgt.DischargeMessageId),\n&quot; +
    &quot;  tgt.DischargeDispositionCode= COALESCE(src.DischargeDispositionCode, tgt.DischargeDispositionCode),\n&quot; +
    &quot;  tgt.PrincipalDiagnosisCode  = COALESCE(src.PrincipalDiagnosisCode, tgt.PrincipalDiagnosisCode),\n&quot; +
    &quot;  tgt.ObservationFlag         = COALESCE(src.ObservationFlag, tgt.ObservationFlag),\n&quot; +
    &quot;  tgt.FollowUpProviderKey     = COALESCE(src.FollowUpProviderKey, tgt.FollowUpProviderKey),\n&quot; +
    &quot;  tgt.FollowUpApptDateTime    = COALESCE(src.FollowUpApptDateTime, tgt.FollowUpApptDateTime),\n&quot; +
    &quot;  tgt.CommunicationSentDate   = COALESCE(src.CommunicationSentDate, tgt.CommunicationSentDate),\n&quot; +
    &quot;  tgt.TCMContactDate          = COALESCE(src.TCMContactDate, tgt.TCMContactDate),\n&quot; +
    &quot;  tgt.TCMMethod               = COALESCE(src.TCMMethod, tgt.TCMMethod),\n&quot; +
    &quot;  tgt.HandoffAcknowledgedDate = COALESCE(src.HandoffAcknowledgedDate, tgt.HandoffAcknowledgedDate),\n&quot; +
    &quot;  tgt.ReadmissionSourceEncKey = COALESCE(src.ReadmissionSourceEncKey, tgt.ReadmissionSourceEncKey),\n&quot; +
    &quot;  tgt.PayerName               = COALESCE(src.PayerName, tgt.PayerName),\n&quot; +
    &quot;  tgt.MemberId                = COALESCE(src.MemberId, tgt.MemberId),\n&quot; +
    &quot;  tgt.AttendingProviderKey    = COALESCE(src.AttendingProviderKey, tgt.AttendingProviderKey),\n&quot; +
    &quot;  tgt.AdmittingProviderKey    = COALESCE(src.AdmittingProviderKey, tgt.AdmittingProviderKey),\n&quot; +
    &quot;  tgt.DischargeProviderKey    = COALESCE(src.DischargeProviderKey, tgt.DischargeProviderKey),\n&quot; +
    &quot;  tgt.Status                  = COALESCE(src.Status, tgt.Status),\n&quot; +
    &quot;  tgt.LastUpdatedUtc          = SYSUTCDATETIME()\n&quot; +
    &quot;WHEN NOT MATCHED THEN \n&quot; +
    &quot;  INSERT (\n&quot; +
    &quot;    TenantKey, HospitalKey, PatientKey, VisitNumber,\n&quot; +
    &quot;    AdmitDateTime, DischargeDateTime,\n&quot; +
    &quot;    PatientClass, Location, AdmitType, AdmitSource,\n&quot; +
    &quot;    VisitStatus, Notes,\n&quot; +
    &quot;    AttendingDoctor, AdmittingDoctor, PrimaryDoctor,\n&quot; +
    &quot;    AdmitMessageId, DischargeMessageId,\n&quot; +
    &quot;    DischargeDispositionCode, PrincipalDiagnosisCode,\n&quot; +
    &quot;    ObservationFlag, FollowUpProviderKey, FollowUpApptDateTime,\n&quot; +
    &quot;    CommunicationSentDate, TCMContactDate, TCMMethod, HandoffAcknowledgedDate,\n&quot; +
    &quot;    ReadmissionSourceEncKey,\n&quot; +
    &quot;    PayerName, MemberId,\n&quot; +
    &quot;    AttendingProviderKey, AdmittingProviderKey, DischargeProviderKey,\n&quot; +
    &quot;    Status\n&quot; +
    &quot;  ) VALUES (\n&quot; +
    &quot;    src.TenantKey, src.HospitalKey, src.PatientKey, src.VisitNumber,\n&quot; +
    &quot;    src.AdmitDateTime, src.DischargeDateTime,\n&quot; +
    &quot;    src.PatientClass, src.Location, src.AdmitType, src.AdmitSource,\n&quot; +
    &quot;    src.VisitStatus, src.Notes,\n&quot; +
    &quot;    src.AttendingDoctor, src.AdmittingDoctor, src.PrimaryDoctor,\n&quot; +
    &quot;    src.AdmitMessageId, src.DischargeMessageId,\n&quot; +
    &quot;    src.DischargeDispositionCode, src.PrincipalDiagnosisCode,\n&quot; +
    &quot;    src.ObservationFlag, src.FollowUpProviderKey, src.FollowUpApptDateTime,\n&quot; +
    &quot;    src.CommunicationSentDate, src.TCMContactDate, src.TCMMethod, src.HandoffAcknowledgedDate,\n&quot; +
    &quot;    src.ReadmissionSourceEncKey,\n&quot; +
    &quot;    src.PayerName, src.MemberId,\n&quot; +
    &quot;    src.AttendingProviderKey, src.AdmittingProviderKey, src.DischargeProviderKey,\n&quot; +
    &quot;    src.Status\n&quot; +
    &quot;  );&quot;;

//  logger.debug(&quot;upsertEncounter MERGE:\n&quot; + merge);
  var resp = insertQueryBuilder(merge);
  return resp;
}
</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>af0d1cc8-7e94-467f-a401-6f82872fad15</id>
            <name>upsertPatient</name>
            <revision>17</revision>
            <lastModified>
              <time>1760883082122</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
 * Upsert Patient into he.Patient using MERGE.
 * Match key: TenantKey + AssigningAuthority + MRN
 * Updates demographics, contact, payer, preferences, PCPProviderKey.
 *
 * Expects `patient` to include (strings unless noted):
 *  TenantKey, PatientIdExternal, AssigningAuthority, MRN, SSN,
 *  FamilyName, GivenName, DOB_TS (MM/DD/YYYY), Sex,
 *  Phone, Email, PreferredLanguage, CommunicationConsent (0|1),
 *  PayerName, MemberId,
 *  AddressLine1, City, State, PostalCode, Country,
 *  PCPProviderKey (int or null)
 */
function upsertPatient(patient) {
  // ---- helpers -------------------------------------------------------------
  function esc(val) {
    return (val == null) ? null : String(val).replace(/&apos;/g, &quot;&apos;&apos;&quot;);
  }
  function toSqlStr(val) {
    if (val == null) return &quot;NULL&quot;;
    var s = String(val).trim();
    return s === &quot;&quot; ? &quot;NULL&quot; : &quot;&apos;&quot; + esc(s) + &quot;&apos;&quot;;
  }
  function toSqlInt(val) {
    if (val == null || String(val).trim() === &quot;&quot;) return &quot;NULL&quot;;
    var n = Number(val);
    return isNaN(n) ? &quot;NULL&quot; : String(Math.trunc(n));
  }
  function toSqlBit(val) {
    // accept 1/0/true/false/&quot;true&quot;/&quot;false&quot;
    if (val === true || String(val).toLowerCase() === &quot;true&quot;) return &quot;1&quot;;
    if (val === 1 || String(val) === &quot;1&quot;) return &quot;1&quot;;
    return &quot;0&quot;;
  }
  function toSqlDateFromDobTs(mmddyyyy) {
    // input like &quot;12/03/1975&quot; or &quot;&quot; -&gt; returns &apos;1975-12-03&apos; or NULL
    if (!mmddyyyy) return &quot;NULL&quot;;
    var s = String(mmddyyyy).trim();
    if (!s) return &quot;NULL&quot;;
    var m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (!m) return &quot;NULL&quot;;
    var mm = m[1].padStart(2, &apos;0&apos;);
    var dd = m[2].padStart(2, &apos;0&apos;);
    var yyyy = m[3];
    return &quot;&apos;&quot; + yyyy + &quot;-&quot; + mm + &quot;-&quot; + dd + &quot;&apos;&quot;;
  }

  // ---- source projection (handle null/empty) -------------------------------
  var TenantKey           = toSqlStr(patient.TenantKey);
  var PatientIdExternal   = toSqlStr(patient.PatientIdExternal || patient.MRN); // keep prior behavior: default to MRN
  var AssigningAuthority  = toSqlStr(patient.AssigningAuthority);
  var MRN                 = toSqlStr(patient.MRN);
  var SSN                 = toSqlStr(patient.SSN);
  var FamilyName          = toSqlStr(patient.FamilyName);
  var GivenName           = toSqlStr(patient.GivenName);
  var DOB                 = toSqlDateFromDobTs(patient.DOB_TS); // date
  var Sex                 = toSqlStr(patient.Sex);
  var Phone               = toSqlStr(patient.Phone);
  var Email               = toSqlStr(patient.Email);
  var PreferredLanguage   = toSqlStr(patient.PreferredLanguage);
  var CommunicationConsent= toSqlBit(patient.CommunicationConsent); // bit
  var PayerName           = toSqlStr(patient.PayerName);
  var MemberId            = toSqlStr(patient.MemberId);
  var AddressLine1        = toSqlStr(patient.AddressLine1);
  var City                = toSqlStr(patient.City);
  var State               = toSqlStr(patient.State);
  var PostalCode          = toSqlStr(patient.PostalCode);
  var Country             = toSqlStr(patient.Country);
  var PCPProviderKey      = toSqlInt(patient.PCPProviderKey); // int or NULL

  // ---- MERGE statement -----------------------------------------------------
  // Note: set LastUpdatedUtc = SYSUTCDATETIME() on update for audit
  var src = &quot;&quot;
    + &quot;SELECT &quot;
    + TenantKey            + &quot; AS TenantKey, &quot;
    + PatientIdExternal    + &quot; AS PatientIdExternal, &quot;
    + AssigningAuthority   + &quot; AS AssigningAuthority, &quot;
    + MRN                  + &quot; AS MRN, &quot;
    + SSN                  + &quot; AS SSN, &quot;
    + FamilyName           + &quot; AS FamilyName, &quot;
    + GivenName            + &quot; AS GivenName, &quot;
    + DOB                  + &quot; AS DOB, &quot;
    + Sex                  + &quot; AS Sex, &quot;
    + Phone                + &quot; AS Phone, &quot;
    + Email                + &quot; AS Email, &quot;
    + PreferredLanguage    + &quot; AS PreferredLanguage, &quot;
    + CommunicationConsent + &quot; AS CommunicationConsent, &quot;
    + PayerName            + &quot; AS PayerName, &quot;
    + MemberId             + &quot; AS MemberId, &quot;
    + AddressLine1         + &quot; AS AddressLine1, &quot;
    + City                 + &quot; AS City, &quot;
    + State                + &quot; AS State, &quot;
    + PostalCode           + &quot; AS PostalCode, &quot;
    + Country              + &quot; AS Country, &quot;
    + PCPProviderKey       + &quot; AS PCPProviderKey&quot;;

  var merge =
    &quot;MERGE he.Patient AS tgt \n&quot; +
    &quot;USING (&quot; + src + &quot;) AS src \n&quot; +
    &quot;ON (tgt.TenantKey = src.TenantKey \n&quot; +
    &quot;    AND tgt.AssigningAuthority = src.AssigningAuthority \n&quot; +
    &quot;    AND tgt.MRN = src.MRN)\n&quot; +
    &quot;WHEN MATCHED THEN UPDATE SET \n&quot; +
    &quot;    tgt.PatientIdExternal   = src.PatientIdExternal,\n&quot; +
    &quot;    tgt.SSN                 = src.SSN,\n&quot; +
    &quot;    tgt.FamilyName          = src.FamilyName,\n&quot; +
    &quot;    tgt.GivenName           = src.GivenName,\n&quot; +
    &quot;    tgt.DOB                 = src.DOB,\n&quot; +
    &quot;    tgt.Sex                 = src.Sex,\n&quot; +
    &quot;    tgt.Phone               = src.Phone,\n&quot; +
    &quot;    tgt.Email               = src.Email,\n&quot; +
    &quot;    tgt.PreferredLanguage   = src.PreferredLanguage,\n&quot; +
    &quot;    tgt.CommunicationConsent= src.CommunicationConsent,\n&quot; +
    &quot;    tgt.PayerName           = src.PayerName,\n&quot; +
    &quot;    tgt.MemberId            = src.MemberId,\n&quot; +
    &quot;    tgt.AddressLine1        = src.AddressLine1,\n&quot; +
    &quot;    tgt.City                = src.City,\n&quot; +
    &quot;    tgt.State               = src.State,\n&quot; +
    &quot;    tgt.PostalCode          = src.PostalCode,\n&quot; +
    &quot;    tgt.Country             = src.Country,\n&quot; +
    &quot;    tgt.PCPProviderKey      = src.PCPProviderKey,\n&quot; +
    &quot;    tgt.LastUpdatedUtc      = SYSUTCDATETIME()\n&quot; +
    &quot;WHEN NOT MATCHED THEN \n&quot; +
    &quot;    INSERT (\n&quot; +
    &quot;      TenantKey, PatientIdExternal, AssigningAuthority, MRN, SSN,\n&quot; +
    &quot;      FamilyName, GivenName, DOB, Sex, Phone, Email, PreferredLanguage,\n&quot; +
    &quot;      CommunicationConsent, PayerName, MemberId,\n&quot; +
    &quot;      AddressLine1, City, State, PostalCode, Country, PCPProviderKey\n&quot; +
    &quot;    ) VALUES (\n&quot; +
    &quot;      src.TenantKey, src.PatientIdExternal, src.AssigningAuthority, src.MRN, src.SSN,\n&quot; +
    &quot;      src.FamilyName, src.GivenName, src.DOB, src.Sex, src.Phone, src.Email, src.PreferredLanguage,\n&quot; +
    &quot;      src.CommunicationConsent, src.PayerName, src.MemberId,\n&quot; +
    &quot;      src.AddressLine1, src.City, src.State, src.PostalCode, src.Country, src.PCPProviderKey\n&quot; +
    &quot;    );&quot;;

//  logger.debug(&quot;upsertPatient MERGE:\n&quot; + merge);
  var resp = insertQueryBuilder(merge);
  return resp;
}
</code>
            </properties>
          </codeTemplate>
        </codeTemplates>
      </codeTemplateLibrary>
      <codeTemplateLibrary version="4.4.0">
        <id>0f6b5e3c-4c1a-4286-8e07-1f3f3a144b00</id>
        <name>StandardFunctions</name>
        <revision>5</revision>
        <lastModified>
          <time>1760639264315</time>
          <timezone>Etc/UTC</timezone>
        </lastModified>
        <description></description>
        <includeNewChannels>true</includeNewChannels>
        <enabledChannelIds>
          <string>aaf33967-fc20-40f2-ac82-8f717f7e8fd1</string>
          <string>9494e43b-15ca-4655-aa7e-ffbc323d3921</string>
        </enabledChannelIds>
        <disabledChannelIds/>
        <codeTemplates>
          <codeTemplate version="4.4.0">
            <id>92ab78a8-f08e-4c21-a468-ce83bce6740f</id>
            <name>formatDate</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547899850</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>CHANNEL_UNDEPLOY</contextType>
                <contextType>CHANNEL_DEPLOY</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>GLOBAL_PREPROCESSOR</contextType>
                <contextType>CHANNEL_BATCH</contextType>
                <contextType>CHANNEL_PREPROCESSOR</contextType>
                <contextType>GLOBAL_UNDEPLOY</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>GLOBAL_DEPLOY</contextType>
                <contextType>GLOBAL_POSTPROCESSOR</contextType>
                <contextType>CHANNEL_POSTPROCESSOR</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                <contextType>CHANNEL_ATTACHMENT</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function format the Patient date of Birth string as yyyy/MM/dd

	@param {String} str - dob from Json object
	@return {String} return dob s yyyy/MM/dd
*/

function formatDate(str) {
    let dob = &quot;&quot;;
    if (str.length &gt; 7) {
        const year = str.substr(0, 4),
            day = str.substr(6, 2),
            month = str.substr(4, 2);
        //const D = new Date(y, m, d);
        dob = month + &quot;/&quot; + day + &quot;/&quot; + year;
    }

    return dob;
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>bee63ca6-481e-4f8e-98c9-48e2a2505439</id>
            <name>getContactsJsonObject</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547901116</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function creates a Json object from Json message (contact object)

	@param {String} system - system from JSON message
	@param {String} use - use from JSON message
	@param {String} value - value from JSON message
	@return {String} return Json object
*/
function getContactsJsonObject(system, use, value) {
    return  {
        &quot;system&quot;: system,
        &quot;use&quot;: use,
        &quot;value&quot;: value
    };
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>bf974546-9815-4138-85a2-bbea20fec0b3</id>
            <name>getFullName</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547901307</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Create a full name from a first name, middle name, last name

	@param {String} firstName - First Name
	@param {String} middleName - Middle Name
	@param {String} lastName - Last Name
	@return {String} return description
*/
function getFullName(firstName, lastName, middleName) {
	   let fullName = firstName + &quot; &quot; + middleName + &quot; &quot; + lastName;
	   return fullName = fullName.replace(/\s\s+/g,&apos; &apos;);
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>1571ce79-940a-4d01-9132-f11c700489aa</id>
            <name>getFullNameWithTitle</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547902267</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function getFullNameWithTitle(firstName, lastName, middleName, title) {
	   let fullName = firstName + &quot; &quot; + middleName + &quot; &quot; + lastName;
	   if(isNotEmpty(title)){
	   	fullName += &quot;, &quot; + title;
	   }
	   return fullName = fullName.replace(/\s\s+/g,&apos; &apos;);
	
}
</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>2c545333-4706-4b9b-a8b9-19febb53e969</id>
            <name>getInsuredJsonObject</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547901204</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function creates a Json object from Json message (insured object)

	@return {String} return Json object
*/
function getInsuredJsonObject() {
    // TODO: Enter code here
    return {
        &quot;name&quot;: &apos;&apos;,
        &quot;relationship&quot;: &apos;&apos;,
        &quot;firstname&quot;: &apos;&apos;,
        &quot;middlename&quot;: &apos;&apos;,
        &quot;lastname&quot;: &apos;&apos;,
        &quot;title&quot;: &apos;&apos;,
        &quot;DOB&quot;: &apos;&apos;,
        &quot;sex&quot;: &apos;&apos;,
        &quot;address&quot;: &apos;&apos;,
        &quot;contacts&quot;: &apos;&apos;
    };
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>62b753fa-1362-4887-ae6d-79193f80aeed</id>
            <name>getMetaDataJsonObject</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547899897</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function generate a Json object (meta data)

	@param {String} fileName - name of the file going into meta data Json object
	@param {String} msgControlID - msgControlID from HL7 segment
	@param {String} port - port number going into meta data json object
	@return {String} return meta data Json object
*/
function getMetaDataJsonObject(fileName, msgControlID, port) {
	
    return {
        &quot;document_type&quot;: &quot;ORM_Update&quot;,
        &quot;base64&quot;: &quot;&quot;,
        &quot;msgControlID&quot;: msgControlID,
        &quot;filename&quot;: fileName,
        &quot;port&quot;: port,
        &quot;ip&quot;: &quot;&quot;,
        &quot;status&quot;: &quot;Received&quot;
    };

}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>dc59631b-837f-4ce9-89a0-cea6d430f2d8</id>
            <name>getPersonAge</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547899941</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function getPersonAge(dateOfBirth, formatted, oru) {
	/* Format the Patient date of Birth as yyyy/MM/dd
    calling function method global variable and format the date input value:
    The date of birth must be in a 8 digits value same as HL7 format
    */
	if(this.isNotEmpty(dateOfBirth)){
		if(formatted == false){
			dateOfBirth = DateUtil.convertDate(&quot;yyyyMMdd&quot;, &quot;yyyy/MM/dd&quot;, dateOfBirth); // Format date of birth
		}
		
    		const dob = new Date(dateOfBirth);
    		// Capture the month patient born
    		const pMonth = dob.getMonth();
    		// Set the day of the month patient born
    		const pDate = dob.getDate();
    		// what year the patient born?
    		const pYear = dob.getFullYear();

    		const today = new Date();
    		const sys_Date = today.getDate();
    		const sys_Month = today.getMonth();
    		const sys_Year = today.getFullYear();

    		// Now, subtract the system and Person Dates

    		let age = sys_Year - pYear;
    		
		if(oru == true){
			return (sys_Month &lt; pMonth || (sys_Month === pMonth &amp;&amp; sys_date &lt; pDate)) ? age-- : age;
		}
    		
   		if (sys_Month &lt; pMonth || (sys_Month === pMonth &amp;&amp; sys_Date &lt; pDate)) age--;
    		return age.toString().split(&apos;.&apos;)[0];
    		
	}

}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>f59035fe-8977-40aa-97a0-b520ae6ec87a</id>
            <name>isEmpty</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547899785</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>CHANNEL_UNDEPLOY</contextType>
                <contextType>CHANNEL_DEPLOY</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>GLOBAL_PREPROCESSOR</contextType>
                <contextType>CHANNEL_BATCH</contextType>
                <contextType>CHANNEL_PREPROCESSOR</contextType>
                <contextType>GLOBAL_UNDEPLOY</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>GLOBAL_DEPLOY</contextType>
                <contextType>GLOBAL_POSTPROCESSOR</contextType>
                <contextType>CHANNEL_POSTPROCESSOR</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                <contextType>CHANNEL_ATTACHMENT</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>function isEmpty(data) {
    if(typeof(data) === &apos;object&apos;){
    	try{
    	  if(JSON.stringify(data) === &apos;{}&apos; || JSON.stringify(data) === &apos;[]&apos;){
            return true;
        }else if(!data){
            return true;
        }
    	}catch(e){
    		return &quot;isEmpty ERROR: &quot; + e + &quot; of data:&quot; + data
    		logger.info(&quot;isEmpty ERROR: &quot; + e + &quot; of data:&quot; + data)
    	}

        return false;
    }else if(typeof(data) === &apos;string&apos;){
        if(!data.trim()){
            return true;
        }
        return false;
    }else if(typeof(data) === &apos;undefined&apos;){
        return true;
    }else{
        return false;
    }
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>d88b27c7-b8d3-4295-967b-8c7586cf7421</id>
            <name>isNotEmpty</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547900516</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>CHANNEL_UNDEPLOY</contextType>
                <contextType>CHANNEL_DEPLOY</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>GLOBAL_PREPROCESSOR</contextType>
                <contextType>CHANNEL_BATCH</contextType>
                <contextType>CHANNEL_PREPROCESSOR</contextType>
                <contextType>GLOBAL_UNDEPLOY</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>GLOBAL_DEPLOY</contextType>
                <contextType>GLOBAL_POSTPROCESSOR</contextType>
                <contextType>CHANNEL_POSTPROCESSOR</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                <contextType>CHANNEL_ATTACHMENT</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>function isNotEmpty(data) {
	return !isEmpty(data);
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>0ae75dda-24e6-43d7-8fba-1da280f8b1e8</id>
            <name>isNumber</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547900851</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>CHANNEL_UNDEPLOY</contextType>
                <contextType>CHANNEL_DEPLOY</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>GLOBAL_PREPROCESSOR</contextType>
                <contextType>CHANNEL_BATCH</contextType>
                <contextType>CHANNEL_PREPROCESSOR</contextType>
                <contextType>GLOBAL_UNDEPLOY</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>GLOBAL_DEPLOY</contextType>
                <contextType>GLOBAL_POSTPROCESSOR</contextType>
                <contextType>CHANNEL_POSTPROCESSOR</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                <contextType>CHANNEL_ATTACHMENT</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This fucntion check if data from HL7 segment is a number

	@param {String} data - from HL7 segment
	@return {String} return isNumber/Null
*/
function isNumber(str) {

    const pattern = /^\d+$/;
    if (pattern.test(str) === true) {
        return true;
    }
    return false;
};</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>1958e688-6a5d-41fc-bece-da29e0532470</id>
            <name>setProperCase</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547901881</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	This function set a sentences to proper case

	@param {String} str - string from HL7 segment
	@return {String} return proper case
*/
function setProperCase(str) {
    if (this.isEmpty(str))
        return &quot;&quot;;
    else
        str = str.toString();
    str = str.replace(/\w\S*/g, function(txt) {
        return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
    });

    return str;
}

function sentenceCase2(str) {
    if (this.isEmpty(str))
        return &quot;&quot;;
    else
        str = str.toString();
    str = str.replace(/\w\S*/g, function(txt) {
        return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
    });

    return str;
}</code>
            </properties>
          </codeTemplate>
          <codeTemplate version="4.4.0">
            <id>ee9a521c-2c90-4f9d-81ef-1e6f83955600</id>
            <name>setSexLong</name>
            <revision>1</revision>
            <lastModified>
              <time>1760547902048</time>
              <timezone>Etc/UTC</timezone>
            </lastModified>
            <contextSet>
              <delegate>
                <contextType>DESTINATION_FILTER_TRANSFORMER</contextType>
                <contextType>CHANNEL_UNDEPLOY</contextType>
                <contextType>CHANNEL_DEPLOY</contextType>
                <contextType>DESTINATION_DISPATCHER</contextType>
                <contextType>GLOBAL_PREPROCESSOR</contextType>
                <contextType>CHANNEL_BATCH</contextType>
                <contextType>CHANNEL_PREPROCESSOR</contextType>
                <contextType>GLOBAL_UNDEPLOY</contextType>
                <contextType>SOURCE_RECEIVER</contextType>
                <contextType>GLOBAL_DEPLOY</contextType>
                <contextType>GLOBAL_POSTPROCESSOR</contextType>
                <contextType>CHANNEL_POSTPROCESSOR</contextType>
                <contextType>SOURCE_FILTER_TRANSFORMER</contextType>
                <contextType>DESTINATION_RESPONSE_TRANSFORMER</contextType>
                <contextType>CHANNEL_ATTACHMENT</contextType>
              </delegate>
            </contextSet>
            <properties class="com.mirth.connect.model.codetemplates.BasicCodeTemplateProperties">
              <type>FUNCTION</type>
              <code>/**
	Modify the description here. Modify the function name and parameters as needed. One function per
	template is recommended; create a new code template for each new function.

	@param {String} arg1 - arg1 description
	@return {String} return description
*/
function setSexLong(sex) {
	if(sex=&apos;M&apos;){
		return &apos;Male&apos;
	}
	if(sex=&apos;F&apos;){
		return &apos;Female&apos;
	}
	return &apos;Unknow&apos;
}</code>
            </properties>
          </codeTemplate>
        </codeTemplates>
      </codeTemplateLibrary>
    </codeTemplateLibraries>
  </exportData>
</channel>